<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="shortcut icon"
      href="../assets/img/UN_Habitat_Icon.svg"
      type="image/x-icon"
    />
    <title>Neighborhood Map</title>

    <!-- Simplified Arabic Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <!-- Leaflet Draw CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />

    <!-- Animate.css for animations -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Application CSS -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/tabs.css" />
    <link rel="stylesheet" href="css/map_v2.css" />
    <link rel="stylesheet" href="css/auto-close.css" />
    <link rel="stylesheet" href="css/tabs-toggle.css" />

    <style>
      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-hidden {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .modal-visible {
        opacity: 1;
        visibility: visible;
        display: block !important;
      }
    </style>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: "Noto Naskh Arabic", sans-serif !important;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* Fixed positioning for header and footer regardless of language direction */
      .no-translate {
        position: fixed !important;
        width: 100% !important;
        left: 0 !important;
        right: 0 !important;
      }

      /* Ensure elements inside no-translate containers maintain their position */
      .no-translate * {
        direction: inherit !important;
      }

      /* Override direction for specific elements that need to be translated */
      .no-translate .language-dropdown,
      .no-translate .menu-dropdown-content {
        direction: auto;
      }

      /* Ensure header elements maintain their positions - reversed order */
      #mainHeader .header-logos.right-logos {
        position: absolute !important;
        left: 20px !important;
        right: auto !important;
      }

      #mainHeader > div:first-child {
        position: absolute !important;
        right: 20px !important;
        left: auto !important;
      }

      #mainHeader .header-title {
        position: absolute !important;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        width: auto !important;
        text-align: center !important;
      }

      /* Make both titles visible in the header */
      #mainHeader .title-ar,
      #mainHeader .title-en {
        display: block !important;
      }

      /* Improve appearance of titles in header */
      #mainHeader .header-title {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
      }

      #mainHeader .title-ar {
        font-size: 1.1rem !important;
        margin-bottom: 2px !important;
      }

      #mainHeader .title-en {
        font-size: 0.7rem !important;
        opacity: 0.9 !important;
      }

      /* Ensure footer elements maintain their positions - reversed order */
      #mainFooter .copyright {
        position: absolute !important;
        right: 20px !important;
        left: auto !important;
      }

      #mainFooter .social-icons {
        position: absolute !important;
        left: 20px !important;
        right: auto !important;
      }

      /* Fix for RTL/LTR switching */
      body[dir="ltr"] #mainHeader .header-logos.right-logos,
      body[dir="ltr"] #mainFooter .social-icons {
        right: 20px !important;
        left: auto !important;
      }

      body[dir="ltr"] #mainHeader > div:first-child,
      body[dir="ltr"] #mainFooter .copyright {
        left: 20px !important;
        right: auto !important;
      }

      body[dir="rtl"] #mainHeader .header-logos.right-logos,
      body[dir="rtl"] #mainFooter .social-icons {
        left: 20px !important;
        right: auto !important;
      }

      body[dir="rtl"] #mainHeader > div:first-child,
      body[dir="rtl"] #mainFooter .copyright {
        right: 20px !important;
        left: auto !important;
      }

      #mainHeader {
        position: fixed;
        top: 0;
        width: 100%;
        height: 50px;
        /* Adjust as needed */
        background: #007bff;
        color: white;
        z-index: 1000;
        display: flex;
        align-items: center;
      }

      #mainFooter {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 50px;
        /* Adjust as needed */
        background: #00b2e3;
        color: white;
        z-index: 1000;
        display: flex;
        align-items: center;
      }

      .mainContent {
        /* position: absolute; */
        margin-top: 100px;
        left: 0;
        right: 0;
        bottom: 70px;
        width: 100%;
        overflow: hidden;
        background: #fff;
        box-sizing: border-box;
        display: flex;
        margin: 0;
        padding: 0;
      }

      .main-content {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
      }

      .map-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #map {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      /* Responsive adjustments if needed */
      @media (max-width: 600px) {
        #mainHeader,
        #mainFooter {
          height: 56px;
          font-size: 1rem;
        }

        .mainContent {
          top: 56px;
          height: calc(100vh - 112px);
        }
      }

      .header-logo {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.7);
        object-fit: contain;
      }

      .header-title {
        flex: 1;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
        line-height: 1.4;
      }

      .header-logos {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 5px;
      }

      .header-logos img {
        height: 40px;
        width: 40px;
        object-fit: contain;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.7);
      }

      .title-ar {
        font-size: 1.2rem;
        line-height: 1.4;
        font-weight: bold;
        white-space: normal;
      }

      .title-en {
        font-size: 1.22rem;
        line-height: 1.4;
        font-weight: bold;
        white-space: normal;
      }

      @media (max-width: 768px) {
        .title-en {
          display: none;
        }
      }

      .language-dropdown {
        position: relative;
      }

      .dots-button {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: white;
        padding: 5px;
      }

      .language-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        display: none;
        flex-direction: column;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 2000;
        min-width: 60px;
      }

      .language-menu div {
        padding: 8px 12px;
        cursor: pointer;
        color: #333;
        font-weight: bold;
        text-align: center;
      }

      .language-menu div:hover {
        background-color: #f1f1f1;
      }

      .footer-content {
        margin: 0 auto;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
        color: white;
      }

      .social-icon {
        color: #fff;
        font-size: 1.2rem;
        margin-left: 1rem;
        transition: color 0.3s ease;
      }

      .social-icon:hover {
        color: #3498db;
      }

      footer .copyright img {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.7);
        background-color: white;
        padding: 2px;
        object-fit: contain;
        background-clip: content-box;
        vertical-align: middle;
        margin-right: 8px;
      }

      .footer-logo {
        height: 24px;
        margin-right: 8px;
        vertical-align: middle;
        display: inline-block !important;
      }

      .companyHITech {
        color: white !important;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .companyHITech:hover {
        color: #f0f0f0 !important;
        text-decoration: underline;
      }

      .info-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 350px;
        width: 85vw;
        max-height: 80vh;
        background: #fff;
        color: #222;
        border-radius: 12px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.25);
        z-index: 1500;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        overflow: auto;
        transition: all 0.3s ease;
        display: none;
      }

      .info-panel.open,
      .info-panel.show {
        display: flex;
      }

      .info-panel .close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        cursor: pointer;
        font-size: 1.5rem;
        color: #666;
        background: rgba(240, 240, 240, 0.7);
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
        transition: all 0.2s ease;
      }

      .info-panel .close-btn:hover {
        background: #e53e3e;
        color: white;
        transform: scale(1.1);
      }

      .info-panel h3 {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1e40af;
        /* padding-bottom: 0.4rem; */
        border-bottom: 2px solid #e5e7eb;
        text-align: center;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
      }

      #infoPanelContent,
      #info-content {
        flex: 1 1 auto;
        overflow-y: auto;
        min-height: 50px;
        max-height: 50vh;
      }

      /* جدول المعلومات */
      .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.75rem;
        direction: rtl;
        table-layout: fixed;
        border-radius: 6px;
        overflow: hidden;
      }

      .info-table tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s;
      }

      .info-table tr:last-child {
        border-bottom: none;
      }

      .info-table tr:hover {
        background-color: #f8fafc;
      }

      .info-table th {
        text-align: right;
        padding: 0.6rem 0.4rem;
        font-weight: 600;
        color: #1e40af;
        background-color: #f1f5f9;
      }

      .info-table td {
        padding: 0.5rem 0.4rem;
        vertical-align: middle;
      }

      .info-table td:first-child {
        font-weight: 600;
        color: #4b5563;
        width: 38%;
        border-left: 1px solid #f0f0f0;
        background-color: rgba(241, 245, 249, 0.3);
      }

      .info-table td:last-child {
        color: #111827;
        width: 62%;
      }

      /* تنسيقات خاصة بجدول الأعضاء */
      .members-table-container {
        animation: fadeInUp 0.4s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .members-table {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
      }

      .members-table th {
        background: linear-gradient(
          135deg,
          #1e40af 0%,
          #3b82f6 100%
        ) !important;
        color: white !important;
        text-align: center !important;
        font-size: 1.1rem !important;
        font-weight: 700 !important;
        padding: 15px 12px !important;
        border: none !important;
      }

      .members-table td {
        padding: 14px 12px !important;
        border-bottom: 1px solid #e5e7eb !important;
        transition: all 0.2s ease !important;
      }

      .members-table tr:hover {
        background-color: #e3f2fd !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
      }

      /* تنسيقات للحقول القابلة للنقر */
      .clickable-field {
        position: relative;
        overflow: hidden;
      }

      .clickable-field::after {
        content: "👥";
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        opacity: 0.7;
        pointer-events: none;
      }

      .clickable-field:hover::after {
        opacity: 1;
        animation: bounce 0.6s ease-in-out;
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(-50%);
        }
        40% {
          transform: translateY(-60%);
        }
        60% {
          transform: translateY(-55%);
        }
      }

      /* أزرار لوحة المعلومات */
      .info-panel .button-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-top: 0.4rem;
        padding: 0 0.25rem;
      }

      .info-panel .button-group button {
        padding: 0.5rem 0.8rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Noto Naskh Arabic", sans-serif;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Modern square button base styling for all navigation buttons */
      .info-panel #previous-tab,
      .info-panel #save-changes,
      .info-panel #next-tab,
      .info-panel #browse-btn {
        background-color: #6c757d;
        color: white;
        width: 44px;
        height: 44px;
        padding: 0;
        border: none;
        border-radius: 8px;
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
      }

      /* Previous button - left aligned, icon only */
      .info-panel #previous-tab {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      }

      .info-panel #previous-tab:hover {
        background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      /* Save changes button - center aligned, icon only */
      .info-panel #save-changes {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      }

      .info-panel #save-changes:hover {
        background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
      }

      /* Next button - right aligned, icon only */
      .info-panel #next-tab {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      }

      .info-panel #next-tab:hover {
        background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      /* Browse button - positioned between Next and Previous */
      .info-panel #browse-btn {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      }

      .info-panel #browse-btn:hover {
        background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
      }

      /* Active/pressed state for all buttons */
      .info-panel #previous-tab:active,
      .info-panel #save-changes:active,
      .info-panel #next-tab:active,
      .info-panel #browse-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      /* Disabled state for navigation buttons */
      .info-panel #previous-tab:disabled,
      .info-panel #next-tab:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
        background: #e9ecef;
        color: #6c757d;
        box-shadow: none;
      }

      .info-panel #previous-tab:disabled:hover,
      .info-panel #next-tab:disabled:hover {
        background: #e9ecef;
        transform: none;
        box-shadow: none;
      }

      /* Button icons styling */
      .info-panel #previous-tab i,
      .info-panel #save-changes i,
      .info-panel #next-tab i,
      .info-panel #browse-btn i {
        font-size: 1.2rem;
        line-height: 1;
      }

      /* RTL-specific arrow adjustments */
      body[dir="rtl"] .info-panel #previous-tab i {
        transform: scaleX(-1);
      }

      body[dir="rtl"] .info-panel #next-tab i {
        transform: scaleX(-1);
      }

      /* Subtle animation for button interactions */
      .info-panel #previous-tab::before,
      .info-panel #save-changes::before,
      .info-panel #next-tab::before,
      .info-panel #browse-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 8px;
      }

      .info-panel #previous-tab:hover::before,
      .info-panel #save-changes:hover::before,
      .info-panel #next-tab:hover::before,
      .info-panel #browse-btn:hover::before {
        opacity: 1;
      }

      /* Responsive design for smaller screens */
      @media (max-width: 480px) {
        .info-panel #previous-tab,
        .info-panel #save-changes,
        .info-panel #next-tab,
        .info-panel #browse-btn {
          width: 40px;
          height: 40px;
          font-size: 1.1rem;
        }

        .info-panel .button-group {
          gap: 8px;
          padding: 12px;
        }
      }

      /* Focus states for accessibility */
      .info-panel #previous-tab:focus,
      .info-panel #save-changes:focus,
      .info-panel #next-tab:focus,
      .info-panel #browse-btn:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        .info-panel #previous-tab,
        .info-panel #save-changes,
        .info-panel #next-tab,
        .info-panel #browse-btn {
          border: 2px solid currentColor;
        }
      }

      /* Legacy cancel button styling (for backward compatibility) */
      .info-panel #cancel-changes {
        background-color: #f3f4f6;
        color: #4b5563;
        flex: 1;
      }

      .info-panel #cancel-changes:hover {
        background-color: #e5e7eb;
        transform: translateY(-2px);
      }

      /* Additional styles for the form elements inside info-panel */
      .info-panel .editable-field {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }

      .info-panel .editable-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        outline: none;
      }

      .info-panel select.editable-field {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23555" d="M2 4l4 4 4-4z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 24px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      .info-panel textarea.editable-field {
        min-height: 60px;
        resize: vertical;
      }

      /* Add subtle focus animation for the entire panel */
      .info-panel:focus-within {
        box-shadow: 0 8px 35px rgba(0, 0, 0, 0.28);
      }

      /* Close button animation */
      .info-panel .close-btn:active {
        transform: scale(0.9);
      }

      /* Responsive for mobile */
      @media (max-width: 600px) {
        .info-panel {
          top: 10px;
          left: 5vw;
          right: 5vw;
          max-width: 95vw;
          max-height: 60vh;
          padding: 0.7rem 0.7rem 0.7rem 0.7rem;
          font-size: 0.95rem;
        }

        .info-panel h3 {
          font-size: 1rem;
        }

        .info-panel .button-group button {
          padding: 0.5rem 0.7rem;
          font-size: 0.8rem;
        }
      }

      /* Custom Google Maps-like layers button in bottom left */
      .leaflet-bottom.leaflet-left .leaflet-control-layers {
        margin-left: 20px;
        margin-bottom: 80px;
        /* adjust as needed for your footer */
      }

      .leaflet-control-layers {
        border: none !important;
        background: none !important;
        box-shadow: none !important;
      }

      .leaflet-control-layers-toggle {
        width: 80px !important;
        height: 80px !important;
        border-radius: 16px !important;
        /* background: url("assets/img/cover.jfif") center center/cover no-repeat,#fff !important; */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18) !important;
        border: 1px solid #e0e0e0 !important;
        display: flex !important;
        flex-direction: column;
        align-items: flex-end;
        justify-content: flex-end;
        position: relative;
        overflow: hidden;
        padding: 0;
      }

      :root {
        --layers-text: "الطبقات";
      }

      .leaflet-control-layers-toggle::after {
        content: var(--layers-text, "الطبقات");
        display: block;
        position: absolute;
        bottom: 8px;
        left: 0;
        right: 0;
        text-align: center;
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.7);
        pointer-events: none;
        font-family: "Noto Naskh Arabic", sans-serif;
      }

      .leaflet-control-layers-toggle::before {
        content: "";
        display: block;
        position: absolute;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        width: 32px;
        height: 32px;
        background: url('data:image/svg+xml;utf8,<svg fill="white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2L1 7l11 5 9.9-4.5L12 2zm0 7.7L3.6 7 12 3.3 20.4 7 12 9.7zm0 2.6l-8.4-3.7v2.1l8.4 3.7 8.4-3.7v-2.1l-8.4 3.7zm0 2.6l-8.4-3.7v2.1l8.4 3.7 8.4-3.7v-2.1l-8.4 3.7z"/></svg>')
          center center/contain no-repeat;
        pointer-events: none;
        opacity: 0.95;
      }

      .custom-layers-btn {
        position: absolute;
        bottom: 90px;
        left: 30px;
        width: 90px;
        height: 90px;
        border-radius: 16px;
        background: url("https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80")
            center center/cover no-repeat,
          #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        border: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        cursor: pointer;
        z-index: 1201;
        overflow: hidden;
        transition: box-shadow 0.2s, background 0.2s;
      }

      .custom-layers-btn:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.22);
      }

      .custom-layers-label {
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.7);
        margin-bottom: 8px;
        font-family: "Noto Naskh Arabic", sans-serif;
        pointer-events: none;
      }

      .custom-layers-icon {
        margin-bottom: 18px;
        pointer-events: none;
      }

      .custom-layers-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      }

      .custom-layers-modal.open {
        display: flex;
      }

      .custom-layers-modal-content {
        background: #fff;
        border-radius: 16px;
        padding: 2rem 2.5rem;
        min-width: 260px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        position: relative;
        text-align: center;
      }

      .custom-layers-modal-close {
        position: absolute;
        top: 10px;
        left: 16px;
        font-size: 2rem;
        color: #888;
        cursor: pointer;
        font-weight: bold;
      }

      .gmaps-base-btn {
        position: absolute;
        bottom: 90px;
        left: 30px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1201;
        transition: box-shadow 0.2s, background 0.2s;
        outline: none;
      }

      .gmaps-base-btn:hover {
        background: #f5f5f5;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.22);
      }

      .gmaps-base-icon {
        pointer-events: none;
      }
    </style>
    <style>
      .hero {
        position: relative;
        height: 100vh;
        color: #fff;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        background-color: #1e293b;
      }

      #particles-js {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .hero-content {
        position: relative;
        z-index: 2;
        max-width: 800px;
        padding: 2rem;
      }

      .hero-subtitle {
        font-size: 1.25rem;
        margin-bottom: 2rem;
        line-height: 1.8;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        margin: 0.5rem;
        border-radius: 50px;
        font-size: 1rem;
        text-decoration: none;
        transition: background 0.3s ease;
        display: inline-block;
      }

      .btn-primary {
        background-color: #3b82f6;
        color: #fff;
      }

      .btn-primary:hover {
        background-color: #2563eb;
      }

      .btn-secondary {
        background-color: #e5e7eb;
        color: #1f2937;
      }

      .btn-secondary:hover {
        background-color: #d1d5db;
      }

      .stats {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2rem;
        color: #fff;
      }

      .stat {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
        border-radius: 1rem;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
        min-width: 150px;
      }

      .stat h3 {
        font-size: 2rem;
        margin: 0;
      }

      .stat p {
        margin: 0;
        font-size: 1rem;
      }

      .hero-carousel {
        position: relative;
        height: 100vh;
        overflow: hidden;
        font-family: "Noto Naskh Arabic", sans-serif;
      }

      .carousel-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
      }

      .carousel-track {
        display: flex;
        height: 100%;
        width: 100%;
        transition: transform 0.5s ease;
      }

      .carousel-slide {
        min-width: 100%;
        height: 100%;
        flex-shrink: 0;
        background-size: cover;
        background-position: center;
        position: relative;
      }

      .overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.6),
          rgba(0, 0, 0, 0.1)
        );
        z-index: 1;
      }

      .slide-content {
        font-size: 2.2rem;
        margin-bottom: 500px;
        font-weight: 700;
        color: white;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
      }

      .slide-content h2 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
      }

      .slide-content p {
        font-size: 1.2rem;
        line-height: 1.6;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
      }

      .slide-content .btn {
        margin: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 30px;
        font-weight: bold;
        text-decoration: none;
        transition: 0.3s;
      }

      .btn-primary {
        background-color: #3b82f6;
        color: #fff;
      }

      .btn-secondary {
        background-color: #f3f4f6;
        color: #1f2937;
      }

      .btn-primary:hover {
        background-color: #2563eb;
      }

      .btn-secondary:hover {
        background-color: #e5e7eb;
      }

      .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        font-size: 2rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        z-index: 5;
        transition: 0.3s;
      }

      .carousel-btn:hover {
        background-color: rgba(255, 255, 255, 0.5);
      }

      .carousel-btn.prev {
        left: 15px;
      }

      .carousel-btn.next {
        right: 15px;
      }

      /* جعل mainContent يأخذ المساحة المتاحة */
      #mainContent {
        flex: 1;
        width: 100%;
        height: calc(100vh - 120px);
        /* 120px = ارتفاع الهيدر + الفوتر */
        margin: 0;
        padding: 0;
        position: relative;
      }

      /* تعديلات السلايدر */
      .swiper-container {
        width: 100%;
        height: 100%;
      }

      .swiper-slide {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* التأكد من أن محتوى السلايد يغطي المساحة كاملة */
      .swiper-slide > div {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      /* تعديلات للغة الإنجليزية */
      body[dir="ltr"] .header-title {
        text-align: center;
      }

      body[dir="ltr"] .header-logos.right-logos {
        margin-left: auto;
      }

      body[dir="ltr"] .language-menu {
        left: auto;
        right: 0;
      }

      body[dir="ltr"] .social-icon {
        margin-left: 0;
        margin-right: 1rem;
      }

      body[dir="ltr"] .footer-content {
        direction: ltr;
      }

      body[dir="ltr"] .footer-logo {
        margin-right: 0;
        margin-left: 8px;
      }

      body[dir="ltr"] .copyright-text {
        direction: ltr;
      }

      body[dir="ltr"] .slide-content {
        text-align: center;
      }
    </style>
    <style>
      /* Pin Button Styles */
      .sidebar-pin {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #ddd;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        padding: 0;
        border-radius: 4px;
        position: relative;
        margin: 0 8px;
        transition: all 0.3s ease;
      }

      .sidebar-pin:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .sidebar-pin.active {
        background: #4caf50;
        color: white;
      }

      .sidebar-pin.active:hover {
        background: #45a049;
      }

      /* Sidebar Animation Styles */
      .sidebar {
        transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1),
          opacity 0.8s ease, box-shadow 0.5s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        will-change: transform, opacity;
      }

      /* Improved sidebar toggle button animation */
      .sidebar-toggle {
        /* Restore original button properties */
        background: #2196f3;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        padding: 0;
        border-radius: 4px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);

        /* Add improved animation */
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275),
          background-color 0.3s ease, color 0.3s ease;
        will-change: transform;
      }

      /* Fix collapsed sidebar toggle button position */
      .sidebar.collapsed .sidebar-toggle {
        position: fixed;
        top: 45%;
        z-index: 1000;
      }

      .left-sidebar.collapsed .sidebar-toggle {
        left: 35px;
      }

      .right-sidebar.collapsed .sidebar-toggle {
        left: auto;
        right: 35px;
      }

      /* Improved hover effects */
      .left-sidebar .sidebar-toggle:hover {
        background-color: rgba(30, 64, 175, 1);
        transform: translateX(3px) rotate(-5deg);
      }

      .right-sidebar .sidebar-toggle:hover {
        background-color: rgba(30, 64, 175, 1);
        transform: translateX(-3px) rotate(5deg);
      }

      .left-sidebar {
        transform-origin: left center;
      }

      .right-sidebar {
        transform-origin: right center;
      }

      .sidebar.collapsed {
        opacity: 0.95;
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55),
          opacity 0.4s ease, box-shadow 0.4s ease;
        box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        overflow: visible;
        /* Ensure toggle button remains visible */
      }

      .left-sidebar.collapsed {
        transform: translateX(-100%) scale(0.98);
      }

      .right-sidebar.collapsed {
        transform: translateX(100%) scale(0.98);
      }

      .tabs-container {
        position: fixed;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        bottom: 50px;
        /* نفس ارتفاع الفوتر */
        z-index: 2001;
        /* أكبر من الفوتر */
        background: #fff;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
        width: 85%;
        max-width: 85vw;
        border: 1px solid #ccc;
        overflow-x: auto;
        white-space: nowrap;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      /* إصلاح لعرض التبويبات في كلا اللغتين */
      body[dir="rtl"] .tabs-container,
      body[dir="ltr"] .tabs-container {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
      }

      /* حالات الظهور والاختفاء للتبويبات */
      .tabs-container.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        visibility: visible;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      }

      .tabs-container.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
        visibility: hidden;
        pointer-events: none;
      }

      .tabs-header {
        display: flex;
        gap: 4px;
        padding: 6px;
      }

      .tab-button {
        display: flex;
        align-items: center;
        background: #e0e0e0;
        color: #333;
        border: none;
        border-radius: 8px 8px 0 0;
        padding: 6px 4px;
        font-size: 10px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-direction: row !important;
        /* Force row direction */
        opacity: 0.7;
        transform: scale(0.95);
      }

      .tab-button.active {
        /* background: #ffffff; */
        background: #007bff;
        border-bottom: 2px solid #007bff;
        font-weight: bold;
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        z-index: 10;
        /* color: #007bff; */
        color: #ffffff;
      }

      .tab-button:not(.active) {
        background: #e0e0e0;
        color: #666;
        opacity: 0.7;
      }

      .tab-button:hover {
        background: #d0d0d0;
        opacity: 0.9;
        transform: scale(0.98);
      }

      .tab-button.active:hover {
        transform: scale(1);
        opacity: 1;
      }

      .tab-icon {
        margin-left: 6px !important;
        margin-right: 0 !important;
        color: #007bff;
      }

      .tab-close:hover {
        color: red;
      }
    </style>

    <style>
      body[dir="ltr"] .tab-icon {
        margin-left: 6px !important;
        margin-right: 0 !important;
      }
    </style>
    <style>
      /* إضافة أنماط القائمة المنسدلة */
      .menu-dropdown {
        position: relative;
        display: inline-block;
      }

      .menu-toggle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
        border: 2px solid rgba(255, 255, 255, 0.7);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1.2rem;
      }

      .menu-toggle:hover {
        background: rgba(255, 255, 255, 0.32);
        transform: scale(1.05);
      }

      .menu-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        z-index: 1000;
        margin-top: 5px;
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        text-decoration: none;
        color: #333;
        transition: background-color 0.3s ease;
        font-size: 0.9rem;
      }

      .menu-item i {
        margin-left: 8px;
        width: 20px;
        text-align: center;
        font-size: 1rem;
      }

      .menu-item:hover {
        background-color: #f5f5f5;
      }

      /* تعديلات للغة الإنجليزية */
      body[dir="ltr"] .menu-dropdown-content {
        right: auto;
        left: 0;
      }

      body[dir="ltr"] .menu-item i {
        margin-left: 0;
        margin-right: 8px;
      }

      /* تحسين مظهر زر اللغة */
      .language-toggle {
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
        font-weight: bold;
        font-size: 1.1rem;
        border: 2px solid rgba(255, 255, 255, 0.7);
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: background 0.2s, border 0.2s, box-shadow 0.2s;
      }

      .language-toggle:hover {
        background: rgba(255, 255, 255, 0.32);
        border-color: #fff;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        color: #007bff;
      }

      /* تحسين مظهر الهيدر */
      #mainHeader {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        background-color: #00b2e3;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        height: 50px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-title {
        flex: 1;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
        line-height: 1.4;
      }

      .header-logo {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.7);
        object-fit: contain;
      }

      .header-logos {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 5px;
      }

      .header-logos img {
        height: 40px;
        width: 40px;
        object-fit: contain;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.7);
      }

      .header-back-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
        border: 2px solid rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: 4px;
        transition: all 0.3s;
      }

      .header-back-btn:hover {
        background: rgba(255, 255, 255, 0.32);
        color: #007bff;
        border-color: #fff;
        transform: scale(1.08);
      }

      .header-back-btn i {
        font-size: 1.3rem;
      }
    </style>
    <!-- Map Toolbar CSS -->
    <style>
      .map-toolbar {
        position: fixed;
        top: 60px;
        right: 50%;
        transform: translateX(50%);
        z-index: 1202;
        display: flex;
        flex-direction: row;
        gap: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        padding: 5px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .map-toolbar button {
        background: #2196f3;
        color: #fff;
        border: none;
        border-radius: 4px;
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .map-toolbar button:hover {
        background: #1769aa;
      }

      /* Drawing Tools Toolbar */
      .drawing-tools-toolbar {
        position: fixed;
        top: 105px;
        right: 50%;
        transform: translateX(calc(50% - 36px));
        z-index: 1201;
        display: none;
        flex-direction: column;
        gap: 6px;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .drawing-tools-toolbar.visible {
        display: flex;
        animation: dropdownSlide 0.3s ease;
      }

      .drawing-tools-toolbar button {
        background: #4caf50;
        color: #fff;
        border: none;
        border-radius: 6px;
        width: 100%;
        height: 36px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 12px;
        gap: 8px;
        position: relative;
      }

      .drawing-tools-toolbar button:hover {
        background: #45a049;
        transform: translateX(3px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }

      .drawing-tools-toolbar button:active {
        transform: translateX(0);
      }

      .drawing-tools-toolbar button i {
        font-size: 1rem;
        width: 16px;
        text-align: center;
      }

      .drawing-tools-toolbar button span {
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Individual drawing tool button colors */
      .drawing-tools-toolbar #draw-polyline-btn {
        background: #ff5722;
      }
      .drawing-tools-toolbar #draw-polyline-btn:hover {
        background: #e64a19;
      }

      .drawing-tools-toolbar #draw-polygon-btn {
        background: #2196f3;
      }
      .drawing-tools-toolbar #draw-polygon-btn:hover {
        background: #1976d2;
      }

      .drawing-tools-toolbar #draw-rectangle-btn {
        background: #4caf50;
      }
      .drawing-tools-toolbar #draw-rectangle-btn:hover {
        background: #388e3c;
      }

      .drawing-tools-toolbar #draw-circle-btn {
        background: #ff9800;
      }
      .drawing-tools-toolbar #draw-circle-btn:hover {
        background: #f57c00;
      }

      .drawing-tools-toolbar #draw-marker-btn {
        background: #9c27b0;
      }
      .drawing-tools-toolbar #draw-marker-btn:hover {
        background: #7b1fa2;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateX(50%) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(50%) translateY(0);
        }
      }

      @keyframes dropdownSlide {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Measurement Tools Toolbar */
      .measurement-tools-toolbar {
        position: fixed;
        top: 105px;
        right: 50%;
        transform: translateX(calc(50% + 10px));
        z-index: 1200;
        display: none;
        flex-direction: column;
        gap: 6px;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .measurement-tools-toolbar.visible {
        display: flex;
        animation: dropdownSlide 0.3s ease;
      }

      .measurement-tools-toolbar button {
        background: #17a2b8;
        color: #fff;
        border: none;
        border-radius: 6px;
        width: 100%;
        height: 36px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 0 12px;
        gap: 8px;
        position: relative;
      }

      .measurement-tools-toolbar button:hover {
        transform: translateX(3px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }

      .measurement-tools-toolbar button:active {
        transform: translateX(0);
      }

      .measurement-tools-toolbar button i {
        font-size: 1rem;
        width: 16px;
        text-align: center;
      }

      .measurement-tools-toolbar button span {
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Individual measurement tool button colors */
      .measurement-tools-toolbar #measure-distance-btn {
        background: #dc3545;
      }
      .measurement-tools-toolbar #measure-distance-btn:hover {
        background: #c82333;
      }

      .measurement-tools-toolbar #measure-area-btn {
        background: #28a745;
      }
      .measurement-tools-toolbar #measure-area-btn:hover {
        background: #218838;
      }
    </style>
    <!-- Leaflet Measure CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css"
    />
    <style>
      .tabs-toggle-btn-container {
        display: none;
        /* Hide the old container completely */
      }

      /* Footer center button styling */
      .footer-center-btn {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 2002;
      }

      .tabs-toggle-btn {
        background: #3066ff;
        color: #fff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        font-size: 1.4rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }

      .tabs-toggle-btn:hover {
        background: #ff4f30;
      }

      /* Fix the footer position */
      #mainFooter {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 50px;
        background: #00b2e3;
        color: white;
        z-index: 1000;
        display: flex;
        align-items: center;
      }

      .footer-content {
        position: relative;
        margin: 0 auto;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
        color: white;
      }
    </style>
    <!-- Add new CSS for preserving direction -->
    <style>
      /* Prevent direction changes for map-toolbar, drawing-tools-toolbar, measurement-tools-toolbar and tabs-container */
      .map-toolbar,
      .drawing-tools-toolbar,
      .measurement-tools-toolbar,
      .tabs-container {
        direction: rtl !important;
        /* Force RTL direction always */
      }

      /* Fix for icon alignment in map toolbar buttons */
      .map-toolbar button i {
        margin: 0;
      }

      /* Fix for tab buttons alignment */
      .tab-button {
        flex-direction: row;
      }

      .tab-icon {
        margin-left: 6px;
        margin-right: 0;
      }

      /* Override any language-specific direction changes */
      body[dir="ltr"] .map-toolbar,
      body[dir="ltr"] .drawing-tools-toolbar,
      body[dir="ltr"] .measurement-tools-toolbar,
      body[dir="ltr"] .tabs-container {
        direction: rtl !important;
      }

      /* Fix for basemap gallery and compass visibility */
      .map-compass {
        display: flex !important;
        visibility: visible !important;
        z-index: 3000 !important;
        pointer-events: auto !important;
      }

      .basemap-thumb {
        display: inline-block !important;
        margin: 5px !important;
        cursor: pointer !important;
        transition: transform 0.2s !important;
      }

      .basemap-thumb:hover {
        transform: scale(1.05) !important;
      }

      .basemap-thumb img {
        width: 80px !important;
        height: 80px !important;
        object-fit: cover !important;
        border-radius: 8px !important;
        border: 3px solid #eee !important;
      }

      .basemap-thumb.selected img {
        border-color: #2196f3 !important;
      }
    </style>

    <style>
      .map-compass {
        position: fixed;
        right: 20px;
        bottom: 60px;
        width: 48px;
        height: 48px;
        z-index: 999;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
      }

      .map-compass img {
        width: 36px;
        height: 36px;
      }
    </style>

    <!-- Container Z-Index Management -->
    <style>
      #sectoral-functionality-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 1001;
        overflow-y: auto;
      }

      #sectoral-mapping-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 1002;
        overflow-y: auto;
      }

      #popup-content-container {
        position: relative;
        z-index: 1000;
      }

      /* Ensure proper layering */
      .popup-content-container {
        position: relative;
        z-index: 1000;
      }
    </style>

    <!-- Measurement Result Floating Box -->
    <div
      id="measure-result-box"
      class="measure-result-box"
      style="display: none"
    ></div>
    <style>
      .measure-result-box {
        position: fixed;
        top: 80px;
        right: 30px;
        background: #fff;
        color: #1e40af;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.18);
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: bold;
        z-index: 3001;
        min-width: 120px;
        text-align: center;
        border: 2px solid #2196f3;
        transition: opacity 0.3s;
      }

      /* Full Screen Popup Styles */
      .fullscreen-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }

      .fullscreen-popup.show {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }

      .fullscreen-popup-content {
        background: #fff;
        width: 95vw;
        height: 90vh;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: scale(0.8) translateY(50px);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .fullscreen-popup.show .fullscreen-popup-content {
        transform: scale(1) translateY(0);
      }

      .fullscreen-popup-close {
        position: absolute;
        top: 25px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .fullscreen-popup-close:hover {
        background: #e53e3e;
        color: white;
        transform: scale(1.1) rotate(90deg);
      }

      .fullscreen-popup-body {
        padding: 10px;
        height: 100%;
        overflow: hidden;
        font-family: "Noto Naskh Arabic", sans-serif;
        display: flex;
        flex-direction: column;
      }

      .popup-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #4b5563;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .popup-content-container {
        height: 100%;
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .popup-content-container .container-fluid {
        height: 100%;
        padding: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .popup-content-container .row {
        height: 100%;
        margin: 0;
        flex: 1;
        display: flex;
        align-items: stretch;
      }

      .popup-content-container .col-md-4,
      .popup-content-container .col-md-8 {
        display: flex;
        flex-direction: column;
        padding: 5px;
      }

      .popup-content-container .section-container {
        margin: 0;
        height: 100%;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .popup-content-container .col-md-8 .section-container {
        align-items: center;
        justify-content: center;
        position: relative;
        min-height: 400px;
      }

      .popup-content-container .col-md-4 .section-container {
        display: flex;
        flex-direction: column;
        max-height: 100%;
      }

      .popup-content-container .col-md-4 form {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
      }

      /* Animation for popup entrance */
      @keyframes popupSlideIn {
        from {
          opacity: 0;
          transform: scale(0.7) translateY(100px);
        }

        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      /* Responsive design for smaller screens */
      @media (max-width: 768px) {
        .fullscreen-popup-content {
          width: 95vw;
          height: 90vh;
          border-radius: 12px;
        }

        .fullscreen-popup-body {
          padding: 50px 20px 20px 20px;
        }

        .fullscreen-popup-close {
          top: 15px;
          left: 15px;
          width: 40px;
          height: 40px;
          font-size: 1.2rem;
        }

        .popup-content-container .row {
          flex-direction: column;
        }

        .popup-content-container .col-md-4,
        .popup-content-container .col-md-8 {
          padding: 5px;
        }

        .popup-content-container .col-md-4 {
          max-height: 40%;
        }

        .popup-content-container .col-md-8 {
          flex: 1;
        }
      }

      /* Enhanced Value Selector and Cancel Button Styles */
      .sidebar-select,
      .query-builder select,
      #reportNeighborhoodSelect,
      #queryTableSelect,
      #queryFieldSelect,
      #queryOperatorSelect,
      #layerStyleSelect,
      #sectorFilterSelect {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007bff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: left 12px center;
        background-size: 18px;
        padding-left: 45px;
        width: 100%;
        min-height: 48px;
      }

      body[dir="ltr"] .sidebar-select,
      body[dir="ltr"] .query-builder select,
      body[dir="ltr"] #reportNeighborhoodSelect,
      body[dir="ltr"] #queryTableSelect,
      body[dir="ltr"] #queryFieldSelect,
      body[dir="ltr"] #queryOperatorSelect,
      body[dir="ltr"] #layerStyleSelect,
      body[dir="ltr"] #sectorFilterSelect {
        background-position: right 12px center;
        padding-left: 16px;
        padding-right: 45px;
      }

      .sidebar-select:focus,
      .query-builder select:focus,
      #reportNeighborhoodSelect:focus,
      #queryTableSelect:focus,
      #queryFieldSelect:focus,
      #queryOperatorSelect:focus,
      #layerStyleSelect:focus,
      #sectorFilterSelect:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15),
          0 4px 12px rgba(0, 123, 255, 0.1);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        transform: translateY(-1px);
      }

      .sidebar-select:hover,
      .query-builder select:hover,
      #reportNeighborhoodSelect:hover,
      #queryTableSelect:hover,
      #queryFieldSelect:hover,
      #queryOperatorSelect:hover,
      #layerStyleSelect:hover,
      #sectorFilterSelect:hover {
        border-color: #007bff;
        box-shadow: 0 4px 16px rgba(0, 123, 255, 0.12);
        transform: translateY(-2px);
        background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
      }

      /* Enhanced Cancel Button Styles */
      .cancel-btn,
      .btn-cancel,
      .cancel-button,
      [id*="cancel"]:not(input),
      [class*="cancel"]:not(input),
      .modal-close,
      .close-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 30px;
        position: relative;
        overflow: hidden;
      }

      .cancel-btn::before,
      .btn-cancel::before,
      .cancel-button::before,
      [id*="cancel"]:not(input)::before,
      [class*="cancel"]:not(input)::before,
      .modal-close::before,
      .close-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .cancel-btn:hover,
      .btn-cancel:hover,
      .cancel-button:hover,
      [id*="cancel"]:not(input):hover,
      [class*="cancel"]:not(input):hover,
      .modal-close:hover,
      .close-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 20px rgba(255, 82, 82, 0.4);
      }

      .cancel-btn:hover::before,
      .btn-cancel:hover::before,
      .cancel-button:hover::before,
      [id*="cancel"]:not(input):hover::before,
      [class*="cancel"]:not(input):hover::before,
      .modal-close:hover::before,
      .close-btn:hover::before {
        left: 100%;
      }

      .cancel-btn:active,
      .btn-cancel:active,
      .cancel-button:active,
      [id*="cancel"]:not(input):active,
      [class*="cancel"]:not(input):active,
      .modal-close:active,
      .close-btn:active {
        transform: translateY(-1px) scale(0.98);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
      }

      /* Enhanced fullscreen popup close button */
      .fullscreen-popup-close {
        background: linear-gradient(
          135deg,
          #ff6b6b 0%,
          #ee5a52 100%
        ) !important;
        border: 2px solid rgba(255, 255, 255, 0.2) !important;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4) !important;
      }

      .fullscreen-popup-close:hover {
        background: linear-gradient(
          135deg,
          #ff5252 0%,
          #d32f2f 100%
        ) !important;
        box-shadow: 0 6px 20px rgba(255, 82, 82, 0.5) !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
      }
    </style>
    <!-- html2canvas for screenshot -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>

  <body>
    <!-- Header -->
    <header id="mainHeader" class="no-translate">
      <div style="display: flex; align-items: center; gap: 10px">
        <!-- شعار يسار -->
        <img
          src="../assets/img/unhabitat.jfif"
          alt="Logo 3"
          class="header-logo"
          onclick="window.location.href='../admin.html'"
          style="cursor: pointer"
        />

        <!-- زر اللغة -->
        <div class="language-dropdown">
          <button
            class="language-toggle"
            id="langToggleBtn"
            onclick="toggleLanguage()"
          >
            AR
          </button>
        </div>
        <!-- زر القائمة -->
        <div class="menu-dropdown">
          <button
            class="menu-toggle"
            id="menuToggleBtn"
            onclick="toggleMenu()"
            style="
              background-image: url('../assets/img/user1.jpg');
              background-size: cover;
              background-position: center;
            "
          ></button>
          <div class="menu-dropdown-content" id="menuDropdown">
            <a href="#" class="menu-item" id="settingsBtn">
              <i class="fas fa-cog"></i>
              <span id="settingsText">الإعدادات</span>
            </a>
            <a href="#" class="menu-item" id="logoutBtn" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
              <span id="logoutText">تسجيل الخروج</span>
            </a>
          </div>
        </div>
      </div>

      <!-- العنوان في الوسط -->
      <div class="header-title text-center">
        <div class="title-ar">نظام إدارة المعلومات الحضرية _ مدينة حلب</div>
        <div class="title-en">
          Urban Information Management System - Aleppo City
        </div>
      </div>

      <!-- شعاران على اليمين -->
      <div class="header-logos right-logos">
        <img src="../assets/img/aleppo.jfif" alt="Logo 1" class="header-logo" />
        <img src="../assets/img/japan.png" alt="Logo 2" class="header-logo" />
      </div>
    </header>

    <div class="mainContent">
      <div class="main-content">
        <div class="map-container">
          <div class="tabs-container">
            <!-- سيتم إنشاء tabs-header تلقائياً من tabs.js -->
          </div>

          <!-- Map Toolbar -->
          <div class="map-toolbar">
            <button id="zoom-in-btn" title="Zoom In">
              <i class="fas fa-search-plus"></i>
            </button>
            <button id="zoom-out-btn" title="Zoom Out">
              <i class="fas fa-search-minus"></i>
            </button>
            <button id="home-btn" title="Home">
              <i class="fas fa-home"></i>
            </button>
            <button
              id="layers-btn"
              title="الخرائط الأساسية"
              style="background-color: #2196f3; color: white"
            >
              <i class="fas fa-layer-group"></i>
            </button>
            <button id="measure-btn" title="Measure">
              <i class="fas fa-ruler"></i>
            </button>
            <button id="draw-btn" title="Draw">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <button id="printMapBtn" title="Print Map">
              <i class="fas fa-print"></i>
            </button>
            <button id="tabsToggleBtn" title="Toggle Tabs">
              <!-- <i class="fas fa-layer-group"></i> -->
              <i class="fa-solid fa-table-columns"></i>
            </button>
          </div>

          <!-- Measurement Tools Dropdown -->
          <div class="measurement-tools-toolbar" id="measurement-tools-toolbar">
            <button id="measure-distance-btn" title="قياس مسافة">
              <i class="fas fa-ruler"></i>
              <span>قياس مسافة</span>
            </button>
            <button id="measure-area-btn" title="قياس مساحة">
              <i class="fas fa-expand-arrows-alt"></i>
              <span>قياس مساحة</span>
            </button>
          </div>

          <!-- Drawing Tools Dropdown -->
          <div class="drawing-tools-toolbar" id="drawing-tools-toolbar">
            <button id="draw-polyline-btn" title="رسم خط">
              <i class="fas fa-slash"></i>
              <span>رسم خط</span>
            </button>
            <button id="draw-polygon-btn" title="رسم مضلع">
              <i class="fas fa-shapes"></i>
              <span>رسم مضلع</span>
            </button>
            <button id="draw-rectangle-btn" title="رسم مستطيل">
              <i class="far fa-square"></i>
              <span>رسم مستطيل</span>
            </button>
            <button id="draw-circle-btn" title="رسم دائرة">
              <i class="far fa-circle"></i>
              <span>رسم دائرة</span>
            </button>
            <button id="draw-marker-btn" title="إضافة نقطة">
              <i class="fas fa-map-marker-alt"></i>
              <span>إضافة نقطة</span>
            </button>
          </div>

          <!-- Basemap Gallery Modal -->
          <div id="basemap-gallery" class="basemap-gallery-modal">
            <!-- Added basemap options with inline SVG instead of image files -->
            <div class="basemap-thumb" data-basemap="osm">
              <div
                style="
                  width: 80px;
                  height: 80px;
                  background-color: #e6e6e6;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <i
                  class="fas fa-map"
                  style="font-size: 28px; color: #7a7a7a"
                ></i>
              </div>
              <div class="basemap-label">خريطة الشارع</div>
            </div>
            <div class="basemap-thumb" data-basemap="satellite">
              <div
                style="
                  width: 80px;
                  height: 80px;
                  background-color: #2d2d2d;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <i
                  class="fas fa-satellite"
                  style="font-size: 28px; color: #ffffff"
                ></i>
              </div>
              <div class="basemap-label">أقمار صناعية</div>
            </div>
            <div class="basemap-thumb" data-basemap="terrain">
              <div
                style="
                  width: 80px;
                  height: 80px;
                  background-color: #c5e8c5;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <i
                  class="fas fa-mountain"
                  style="font-size: 28px; color: #4a6741"
                ></i>
              </div>
              <div class="basemap-label">تضاريس</div>
            </div>
            <div class="basemap-thumb" data-basemap="dark">
              <div
                style="
                  width: 80px;
                  height: 80px;
                  background-color: #121212;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <i
                  class="fas fa-moon"
                  style="font-size: 28px; color: #ffffff"
                ></i>
              </div>
              <div class="basemap-label">داكن</div>
            </div>
          </div>

          <!-- Add additional basemap button -->

          <!-- Compass (bottom right) -->
          <div class="map-compass" title="الشمال">
            <img src="../assets/img/map-compass.jpg" alt="Compass North" />
          </div>

          <!-- Full Screen Popup Window -->
          <div id="fullscreen-popup" class="fullscreen-popup">
            <div class="fullscreen-popup-content">
              <button
                id="fullscreen-popup-close"
                class="fullscreen-popup-close"
              >
                <i class="fas fa-times"></i>
              </button>
              <div class="fullscreen-popup-body">
                <div id="popup-loading" class="popup-loading">
                  <div class="loading-spinner"></div>
                  <p>جاري التحميل...</p>
                </div>
                <div
                  id="popup-content-container"
                  class="popup-content-container"
                  style="display: none"
                >
                  <!-- Content from window.html will be loaded here -->
                </div>
                <!-- Urban Sectoral Functionality Calculation Container -->
                <div
                  id="sectoral-functionality-container"
                  class="popup-content-container"
                  style="display: none; flex-direction: column"
                >
                  <h3
                    style="
                      padding-top: 35px;
                      padding-bottom: 15px;
                      text-align: center;
                    "
                  >
                    حساب الوظائف القطاعية الحضرية
                  </h3>
                  <div
                    style="
                      display: flex;
                      gap: 10px;
                      margin-bottom: 15px;
                      padding: 0px 20px;
                    "
                  >
                    <button
                      id="randomize-functionality-btn"
                      class="sidebar-button"
                    >
                      <i class="fas fa-sync-alt"></i> تحديث الفعالية القطاعية
                    </button>
                    <button
                      id="apply-sectoral-mapping-btn"
                      class="sidebar-button"
                      style="
                        background: linear-gradient(
                          135deg,
                          #007bff 0%,
                          #0056b3 100%
                        );
                        color: white;
                      "
                    >
                      <i class="fas fa-map-marked-alt"></i> تطبيق الفعالية
                      القطاعية على الأحياء
                    </button>
                  </div>
                  <div style="overflow-y: auto; flex-grow: 1">
                    <table id="sectoral-functionality-table" class="info-table">
                      <thead>
                        <tr>
                          <th>اسم الحي</th>
                          <th>تاريخ التعديل</th>
                          <th>التدخلات الإنسانية</th>
                          <th>الأسواق الأساسية</th>
                          <th>إدارة النفايات الصلبة</th>
                          <th>شبكة الكهرباء</th>
                          <th>شبكة الاتصالات</th>
                          <th>إمدادات المياه</th>
                          <th>شبكة الصرف الصحي</th>
                          <th>أضرار الإسكان</th>
                          <th>النسيج الحضري</th>
                          <th>التغيرات السكانية</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Table rows will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Composite Urban Functionality Container -->
                <div
                  id="composite-functionality-container"
                  class="popup-content-container"
                  style="display: none; flex-direction: column"
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 20px;
                      border-bottom: 2px solid #e9ecef;
                      padding-bottom: 15px;
                    "
                  >
                    <h3 style="color: #333; margin: 0">
                      <i class="fas fa-calculator" style="color: #28a745"></i>
                      الفعالية العمرانية المجردة
                    </h3>
                  </div>

                  <!-- Weights Section -->
                  <div
                    style="
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 10px;
                      margin-bottom: 20px;
                    "
                  >
                    <h4 style="color: #495057; margin-bottom: 15px">
                      <i class="fas fa-balance-scale"></i> تحديد أوزان القطاعات
                    </h4>
                    <div
                      id="weightsGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fit,
                          minmax(300px, 1fr)
                        );
                        gap: 15px;
                        margin-bottom: 15px;
                      "
                    >
                      <!-- Weights will be populated by JavaScript -->
                    </div>

                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 15px;
                        padding: 10px;
                        background: white;
                        border-radius: 8px;
                        border: 1px solid #dee2e6;
                      "
                    >
                      <span style="font-weight: bold; color: #495057"
                        >مجموع الأوزان:</span
                      >
                      <span
                        id="totalWeight"
                        style="
                          font-size: 18px;
                          font-weight: bold;
                          color: #007bff;
                        "
                        >0</span
                      >
                      <span style="color: #6c757d">/ 100</span>
                    </div>

                    <div style="text-align: center; margin-top: 15px">
                      <button
                        id="calculateCompositeBtn"
                        class="sidebar-button"
                        style="
                          background: linear-gradient(
                            135deg,
                            #28a745 0%,
                            #20c997 100%
                          );
                          color: white;
                          border: none;
                          padding: 12px 30px;
                          border-radius: 8px;
                          font-size: 16px;
                          font-weight: bold;
                          cursor: pointer;
                          box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                          transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'"
                      >
                        <i class="fas fa-calculator"></i> حساب الفعالية المجردة
                      </button>
                    </div>
                  </div>

                  <!-- Results Section -->
                  <div id="compositeResultsSection" style="display: none">
                    <h4 style="color: #495057; margin-bottom: 15px">
                      <i class="fas fa-chart-bar"></i> نتائج الفعالية العمرانية
                      المركبة
                    </h4>

                    <div
                      style="
                        overflow-y: auto;
                        max-height: 400px;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                      "
                    >
                      <table id="composite-results-table" class="info-table">
                        <thead>
                          <tr>
                            <th>اسم الحي</th>
                            <th>الفعالية المركبة (%)</th>
                            <th>التصنيف</th>
                            <th>اللون</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Results will be populated by JavaScript -->
                        </tbody>
                      </table>
                    </div>

                    <div
                      style="
                        text-align: center;
                        margin-top: 15px;
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        align-items: center;
                      "
                    >
                      <button
                        id="applyCompositeColoringBtn"
                        class="sidebar-button"
                        style="
                          background: linear-gradient(
                            135deg,
                            #007bff 0%,
                            #0056b3 100%
                          );
                          color: white;
                          border: none;
                          padding: 12px 30px;
                          border-radius: 8px;
                          font-size: 16px;
                          font-weight: bold;
                          cursor: pointer;
                          box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
                          transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'"
                      >
                        <i class="fas fa-paint-brush"></i> تطبيق التلوين على
                        الخريطة
                      </button>

                      <!-- Temporary Debug Button -->
                      <button
                        onclick="window.diagnoseMapLayers()"
                        style="
                          background: #dc3545;
                          color: white;
                          border: none;
                          padding: 8px 12px;
                          border-radius: 6px;
                          font-size: 12px;
                          cursor: pointer;
                          transition: all 0.3s ease;
                        "
                        title="تشخيص طبقات الخريطة (للمطورين)"
                      >
                        <i class="fas fa-bug"></i> تشخيص
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Sectoral Mapping Interface Container -->
                <div
                  id="sectoral-mapping-container"
                  class="popup-content-container"
                  style="display: none; flex-direction: column"
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin: 30px 0;
                      padding: 0 25px;
                      border-bottom: 2px solid #e9ecef;
                      padding-top: 45px;
                    "
                  >
                    <h3 style="color: #333; margin: 0">
                      <i
                        class="fas fa-map-marked-alt"
                        style="color: #007bff"
                      ></i>
                      تطبيق الفعالية القطاعية على الأحياء
                    </h3>
                    <button
                      onclick="showSectoralFunctionalityCalculation()"
                      style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                      "
                    >
                      <i class="fas fa-arrow-left"></i> العودة للجدول
                    </button>
                  </div>

                  <div style="flex: 1; overflow-y: auto">
                    <!-- Sector Selection Grid -->
                    <div
                      id="sectoralMappingGrid"
                      style="
                        display: grid;
                        grid-template-columns: repeat(
                          auto-fit,
                          minmax(280px, 1fr)
                        );
                        gap: 15px;
                        max-height: 70vh;
                        overflow-y: auto;
                      "
                    >
                      <!-- Sectoral mapping cards will be populated by JavaScript -->
                    </div>

                    <!-- Legend for Blue Gradient -->
                    <div
                      id="blueGradientLegend"
                      style="
                        position: fixed;
                        bottom: 40px;
                        left: 40px;
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        border: 1px solid #dee2e6;
                        display: none;
                        z-index: 1000;
                      "
                    >
                      <h5
                        style="
                          margin: 0 0 10px 0;
                          color: #495057;
                          text-align: center;
                        "
                      >
                        مفتاح الألوان
                      </h5>
                      <div
                        style="display: flex; flex-direction: column; gap: 5px"
                      >
                        <div
                          style="display: flex; align-items: center; gap: 8px"
                        >
                          <div
                            style="
                              width: 20px;
                              height: 15px;
                              background: #0d47a1;
                              border-radius: 3px;
                            "
                          ></div>
                          <span style="font-size: 12px">ممتاز (80%+)</span>
                        </div>
                        <div
                          style="display: flex; align-items: center; gap: 8px"
                        >
                          <div
                            style="
                              width: 20px;
                              height: 15px;
                              background: #1976d2;
                              border-radius: 3px;
                            "
                          ></div>
                          <span style="font-size: 12px">جيد (65-79%)</span>
                        </div>
                        <div
                          style="display: flex; align-items: center; gap: 8px"
                        >
                          <div
                            style="
                              width: 20px;
                              height: 15px;
                              background: #42a5f5;
                              border-radius: 3px;
                            "
                          ></div>
                          <span style="font-size: 12px">متوسط (50-64%)</span>
                        </div>
                        <div
                          style="display: flex; align-items: center; gap: 8px"
                        >
                          <div
                            style="
                              width: 20px;
                              height: 15px;
                              background: #90caf9;
                              border-radius: 3px;
                            "
                          ></div>
                          <span style="font-size: 12px">ضعيف (30-49%)</span>
                        </div>
                        <div
                          style="display: flex; align-items: center; gap: 8px"
                        >
                          <div
                            style="
                              width: 20px;
                              height: 15px;
                              background: #e3f2fd;
                              border-radius: 3px;
                            "
                          ></div>
                          <span style="font-size: 12px">سيء (أقل من 30%)</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Map Toolbar CSS -->

          <div id="map"></div>
          <!-- Map Information Bar -->
          <div id="map-info-bar" class="map-info-bar">
            <div class="info-item">
              <i class="fas fa-ruler-horizontal"></i>
              <span id="map-scale">المقياس: 1:100000</span>
            </div>
            <div class="info-divider">|</div>
            <div class="info-item">
              <i class="fas fa-map-marker-alt"></i>
              <span id="map-center">المركز: 36.2021, 37.1343</span>
            </div>
          </div>
          <div class="tab-content">
            <!-- Tab content will be dynamically added here -->
          </div>

          <!-- Info Panel -->
          <div id="modal-backdrop" class="modal-backdrop"></div>
          <div id="info-panel" class="info-panel">
            <button id="close-info-panel" class="close-btn">&times;</button>
            <h3 id="info-title"></h3>
            <div id="info-content"></div>
          </div>

          <style>
            .modal-backdrop {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0);
              z-index: 1400;
            }

            .modal-backdrop.show {
              display: block;
            }

            /* Enhance info panel show/hide */
            .info-panel.show {
              animation: fadeInPanel 0.3s ease forwards;
            }

            @keyframes fadeInPanel {
              from {
                opacity: 0;
                transform: translate(-50%, -55%) scale(0.95);
              }

              to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
              }
            }

            /* تحسينات خاصة لإظهار التبويبات مع info-panel */
            .tabs-container.visible {
              opacity: 1;
              visibility: visible;
              transition: all 0.3s ease;
            }

            .tabs-container.hidden {
              opacity: 0;
              transform: translateY(20px);
              visibility: hidden;
              transition: all 0.3s ease;
            }

            /* تأثير متقدم عند ظهور التبويبات */
            .tabs-container.visible .tab-button {
              animation: slideInTab 0.4s ease forwards;
            }

            @keyframes slideInTab {
              from {
                opacity: 0;
                transform: translateY(10px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }

            /* تأخير متدرج للتبويبات */
            .tabs-container.visible .tab-button:nth-child(1) {
              animation-delay: 0.1s;
            }
            .tabs-container.visible .tab-button:nth-child(2) {
              animation-delay: 0.15s;
            }
            .tabs-container.visible .tab-button:nth-child(3) {
              animation-delay: 0.2s;
            }
            .tabs-container.visible .tab-button:nth-child(4) {
              animation-delay: 0.25s;
            }
            .tabs-container.visible .tab-button:nth-child(5) {
              animation-delay: 0.3s;
            }
            .tabs-container.visible .tab-button:nth-child(6) {
              animation-delay: 0.35s;
            }
            .tabs-container.visible .tab-button:nth-child(7) {
              animation-delay: 0.4s;
            }
            .tabs-container.visible .tab-button:nth-child(8) {
              animation-delay: 0.45s;
            }
            .tabs-container.visible .tab-button:nth-child(9) {
              animation-delay: 0.5s;
            }

            /* Mini Map Styles */
            .sectoral-mapping-card-with-map {
              transition: all 0.3s ease;
            }

            .sectoral-mapping-card-with-map:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15) !important;
            }

            .mini-map-tooltip {
              background: rgba(0, 0, 0, 0.8) !important;
              border: none !important;
              border-radius: 4px !important;
              color: white !important;
              font-size: 11px !important;
              padding: 5px 8px !important;
            }

            .mini-map-tooltip .leaflet-tooltip-content {
              margin: 0 !important;
              padding: 0 !important;
            }

            /* Scrollbar styling for sectoral mapping grid */
            #sectoralMappingGrid::-webkit-scrollbar {
              width: 8px;
            }

            #sectoralMappingGrid::-webkit-scrollbar-track {
              background: #f1f1f1;
              border-radius: 4px;
            }

            #sectoralMappingGrid::-webkit-scrollbar-thumb {
              background: #007bff;
              border-radius: 4px;
            }

            #sectoralMappingGrid::-webkit-scrollbar-thumb:hover {
              background: #0056b3;
            }

            /* Mini Map Popup Styles */
            .mini-map-popup .leaflet-popup-content-wrapper {
              background: white;
              border-radius: 12px;
              box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
              border: 2px solid #dee2e6;
            }

            .mini-map-popup .leaflet-popup-content {
              margin: 0;
              padding: 0;
            }

            .mini-map-popup .leaflet-popup-tip {
              background: white;
              border: 2px solid #dee2e6;
              border-top: none;
              border-right: none;
            }

            /* Hover effects for mini map */
            .leaflet-interactive:hover {
              cursor: pointer;
            }

            /* Map Information Bar Styles */
            .map-info-bar {
              position: fixed;
              bottom: 60px; /* Above the footer */
              left: 50%;
              transform: translateX(-50%);
              background: rgba(255, 255, 255, 0.95);
              border: 1px solid #ddd;
              border-radius: 25px;
              padding: 5px 10px;
              display: flex;
              align-items: center;
              gap: 12px;
              z-index: 1000;
              box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(10px);
              font-size: 13px;
              color: #333;
              direction: rtl;
              text-align: right;
            }

            .map-info-bar .info-item {
              display: flex;
              align-items: center;
              gap: 6px;
              white-space: nowrap;
            }

            .map-info-bar .info-item i {
              color: #007bff;
              font-size: 12px;
            }

            .map-info-bar .info-divider {
              color: #ccc;
              font-weight: 300;
            }

            @media (max-width: 768px) {
              .map-info-bar {
                bottom: 65px;
                font-size: 11px;
                padding: 6px 15px;
                gap: 8px;
              }

              .map-info-bar .info-item {
                gap: 4px;
              }
            }

            @media (max-width: 480px) {
              .map-info-bar {
                flex-direction: column;
                gap: 4px;
                padding: 8px 12px;
                border-radius: 15px;
              }

              .map-info-bar .info-divider {
                display: none;
              }
            }

            /* Advanced Layer Management Styles */
            .layers-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
              background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
              border-radius: 8px;
              border: 1px solid #dee2e6;
            }

            .layer-toolbar-btn {
              background: #007bff;
              color: white;
              border: none;
              padding: 6px 8px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              transition: all 0.2s ease;
            }

            .layer-toolbar-btn:hover {
              background: #0056b3;
              transform: translateY(-1px);
            }

            .advanced-layer-list {
              max-height: 400px;
              overflow-y: auto;
              border: 1px solid #dee2e6;
              border-radius: 8px;
              background: white;
            }

            .layer-group {
              border-bottom: 1px solid #e9ecef;
            }

            .layer-group:last-child {
              border-bottom: none;
            }

            .layer-group-header {
              display: flex;
              align-items: center;
              padding: 12px;
              background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
              cursor: pointer;
              transition: all 0.2s ease;
              gap: 8px;
            }

            .layer-group-header:hover {
              background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            }

            .layer-group-toggle {
              background: none;
              border: none;
              color: #6c757d;
              cursor: pointer;
              padding: 2px;
              transition: transform 0.2s ease;
            }

            .layer-group-toggle[data-expanded="false"] i {
              transform: rotate(-90deg);
            }

            .layer-group-checkbox input {
              margin: 0;
            }

            .layer-group-icon {
              color: #007bff;
              font-size: 16px;
            }

            .layer-group-name {
              flex: 1;
              font-weight: 600;
              color: #333;
            }

            .layer-group-actions {
              display: flex;
              gap: 4px;
              opacity: 0;
              transition: opacity 0.2s ease;
            }

            .layer-group-header:hover .layer-group-actions {
              opacity: 1;
            }

            .layer-group-content {
              background: #fafafa;
              border-top: 1px solid #e9ecef;
            }

            .layer-group-content[data-collapsed="true"] {
              display: none;
            }

            .layer-item {
              display: flex;
              align-items: center;
              padding: 8px 12px;
              gap: 8px;
              transition: all 0.2s ease;
              cursor: pointer;
            }

            .layer-item:hover {
              background: #f0f0f0;
            }

            .layer-item.selected {
              background: #e3f2fd;
              border-left: 3px solid #007bff;
            }

            .layer-item.dragging {
              opacity: 0.5;
              transform: rotate(2deg);
            }

            .layer-indent {
              width: 20px;
            }

            .layer-checkbox input {
              margin: 0;
            }

            .layer-icon {
              font-size: 14px;
            }

            .layer-name {
              flex: 1;
              font-size: 13px;
              color: #495057;
            }

            .layer-actions {
              display: flex;
              gap: 2px;
              opacity: 0;
              transition: opacity 0.2s ease;
            }

            .layer-item:hover .layer-actions {
              opacity: 1;
            }

            .layer-action-btn {
              background: #6c757d;
              color: white;
              border: none;
              padding: 4px 6px;
              border-radius: 3px;
              cursor: pointer;
              font-size: 10px;
              transition: all 0.2s ease;
            }

            .layer-action-btn:hover {
              background: #495057;
              transform: scale(1.1);
            }

            .layer-drag-handle {
              background: #adb5bd;
              color: white;
              border: none;
              padding: 4px 6px;
              border-radius: 3px;
              cursor: grab;
              font-size: 10px;
            }

            .layer-drag-handle:active {
              cursor: grabbing;
            }

            /* Import/Export Enhanced Styles */
            .import-export-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
              padding: 10px;
              background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
              color: white;
              border-radius: 8px;
            }

            .section-toggle {
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: none;
              padding: 4px 8px;
              border-radius: 4px;
              cursor: pointer;
              transition: all 0.2s ease;
            }

            .section-toggle:hover {
              background: rgba(255, 255, 255, 0.3);
            }

            .data-operation-group {
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
              border: 1px solid #dee2e6;
            }

            .data-operation-group h5 {
              margin: 0 0 12px 0;
              color: #495057;
              font-size: 14px;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 8px;
            }

            .import-options,
            .export-options,
            .print-options {
              display: flex;
              flex-direction: column;
              gap: 10px;
            }

            .import-method {
              display: flex;
              flex-direction: column;
              gap: 5px;
            }

            .operation-button {
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 10px 15px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 13px;
              font-weight: 500;
              transition: all 0.2s ease;
              text-align: left;
            }

            .import-btn {
              background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
              color: white;
            }

            .import-btn:hover {
              background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
              transform: translateY(-1px);
            }

            .export-btn {
              background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
              color: white;
            }

            .export-btn:hover {
              background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
              transform: translateY(-1px);
            }

            .print-btn {
              background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
              color: white;
            }

            .print-btn:hover {
              background: linear-gradient(135deg, #5a2d91 0%, #4c1d7a 100%);
              transform: translateY(-1px);
            }

            .import-formats {
              font-size: 11px;
              color: #6c757d;
              font-style: italic;
            }

            .export-options-advanced {
              display: flex;
              flex-direction: column;
              gap: 8px;
              padding: 10px;
              background: white;
              border-radius: 6px;
              border: 1px solid #dee2e6;
            }

            .export-actions {
              display: flex;
              gap: 10px;
            }

            .export-actions .operation-button {
              flex: 1;
            }
          </style>
        </div>
      </div>

      <!-- Left Sidebar - Layers Management -->
      <aside
        id="leftSidebar"
        class="sidebar left-sidebar"
        style="margin-top: -10px"
      >
        <div class="sidebar-header">
          <button
            title="sidebar toggle"
            id="toggleLeftSidebar"
            class="sidebar-toggle"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
          <button id="pinLeftSidebar" class="sidebar-pin" title="تثبيت القائمة">
            <i class="fas fa-thumbtack"></i>
          </button>
          <h3>إدارة الطبقات</h3>
        </div>
        <!-- Indicador de cierre automático -->
        <div id="leftSidebarAutoCloseIndicator" class="auto-close-indicator">
          <span class="auto-close-countdown"></span>
          <span id="left-auto-close-message">سيتم الإغلاق تلقائيًا</span>
        </div>
        <div class="sidebar-content" style="margin-bottom: 110px">
          <!-- Base Layers Section -->

          <div class="sidebar-section">
            <div class="layers-header">
              <h4><i class="fas fa-layer-group"></i> إدارة الطبقات</h4>
            </div>

            <div id="layersList" class="advanced-layer-list">
              <!-- Advanced layer management will be populated dynamically -->

              <!-- Main Layers Group (Neighborhoods + Service Sectors) -->
              <div class="layer-group" data-layer-group="main-layers">
                <div class="layer-group-header">
                  <button class="layer-group-toggle" data-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                  <div class="layer-group-checkbox">
                    <input type="checkbox" id="group-main-layers" checked />
                  </div>
                  <div class="layer-group-icon">
                    <i class="fas fa-layer-group"></i>
                  </div>
                  <span class="layer-group-name">الطبقات الرئيسية</span>
                  <div class="layer-group-actions">
                    <button
                      class="layer-action-btn"
                      data-action="zoom"
                      data-layer="main-layers"
                      title="تكبير للطبقات"
                    >
                      <i class="fas fa-search-plus"></i>
                    </button>
                    <button
                      class="layer-action-btn"
                      data-action="properties"
                      data-layer="main-layers"
                      title="خصائص المجموعة"
                    >
                      <i class="fas fa-info-circle"></i>
                    </button>
                  </div>
                </div>

                <div class="layer-group-content">
                  <!-- Neighborhoods Sub-Group -->
                  <div class="layer-group" data-layer-group="neighborhoods">
                    <div class="layer-group-header">
                      <button class="layer-group-toggle" data-expanded="true">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <div class="layer-group-checkbox">
                        <input
                          type="checkbox"
                          id="group-neighborhoods"
                          checked
                        />
                      </div>
                      <div class="layer-group-icon">
                        <i class="fas fa-home"></i>
                      </div>
                      <span class="layer-group-name">الأحياء</span>
                      <div class="layer-group-actions">
                        <button
                          class="layer-action-btn"
                          data-action="zoom"
                          data-layer="neighborhoods"
                          title="تكبير للطبقة"
                        >
                          <i class="fas fa-search-plus"></i>
                        </button>
                        <button
                          class="layer-action-btn"
                          data-action="properties"
                          data-layer="neighborhoods"
                          title="خصائص الطبقة"
                        >
                          <i class="fas fa-info-circle"></i>
                        </button>
                        <button
                          class="layer-drag-handle"
                          title="سحب لإعادة الترتيب"
                        >
                          <i class="fas fa-grip-vertical"></i>
                        </button>
                      </div>
                    </div>

                    <div class="layer-group-content">
                      <!-- Neighborhoods sub-layers -->
                      <div
                        class="layer-item"
                        data-layer="neighborhoods-polygons"
                        draggable="true"
                      >
                        <div class="layer-indent"></div>
                        <div class="layer-checkbox">
                          <input
                            type="checkbox"
                            id="layer-neighborhoods-polygons"
                            checked
                          />
                        </div>
                        <div class="layer-icon">
                          <i
                            class="fas fa-vector-square"
                            style="color: #1e40af"
                          ></i>
                        </div>
                        <span class="layer-name">حدود الأحياء</span>
                        <div class="layer-actions">
                          <button
                            class="layer-action-btn"
                            data-action="style"
                            data-layer="neighborhoods-polygons"
                            title="تنسيق الطبقة"
                          >
                            <i class="fas fa-palette"></i>
                          </button>
                          <button
                            class="layer-action-btn"
                            data-action="table"
                            data-layer="neighborhoods-polygons"
                            title="جدول البيانات"
                          >
                            <i class="fas fa-table"></i>
                          </button>
                        </div>
                      </div>

                      <div
                        class="layer-item"
                        data-layer="neighborhoods-labels"
                        draggable="true"
                      >
                        <div class="layer-indent"></div>
                        <div class="layer-checkbox">
                          <input
                            type="checkbox"
                            id="layer-neighborhoods-labels"
                            checked
                          />
                        </div>
                        <div class="layer-icon">
                          <i class="fas fa-font" style="color: #059669"></i>
                        </div>
                        <span class="layer-name">مسميات الأحياء</span>
                        <div class="layer-actions">
                          <button
                            class="layer-action-btn"
                            data-action="style"
                            data-layer="neighborhoods-labels"
                            title="تنسيق النصوص"
                          >
                            <i class="fas fa-text-height"></i>
                          </button>
                          <button
                            class="layer-action-btn"
                            data-action="visibility"
                            data-layer="neighborhoods-labels"
                            title="إعدادات الرؤية"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Aleppo City Layer Group -->
                  <div class="layer-group" data-layer-group="aleppo-city">
                    <div class="layer-group-header">
                      <button class="layer-group-toggle" data-expanded="true">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <div class="layer-group-checkbox">
                        <input type="checkbox" id="group-aleppo-city" checked />
                      </div>
                      <div class="layer-group-icon">
                        <i class="fas fa-city"></i>
                      </div>
                      <span class="layer-group-name">مدينة حلب</span>
                      <div class="layer-group-actions">
                        <button
                          class="layer-action-btn"
                          data-action="zoom"
                          data-layer="aleppo-city"
                          title="تكبير للطبقة"
                        >
                          <i class="fas fa-search-plus"></i>
                        </button>
                        <button
                          class="layer-action-btn"
                          data-action="properties"
                          data-layer="aleppo-city"
                          title="خصائص الطبقة"
                        >
                          <i class="fas fa-info-circle"></i>
                        </button>
                        <button
                          class="layer-drag-handle"
                          title="سحب لإعادة الترتيب"
                        >
                          <i class="fas fa-grip-vertical"></i>
                        </button>
                      </div>
                    </div>

                    <div class="layer-group-content">
                      <!-- Aleppo City sub-layer -->
                      <div
                        class="layer-item"
                        data-layer="aleppo-city-polygon"
                        draggable="true"
                      >
                        <div class="layer-indent"></div>
                        <div class="layer-checkbox">
                          <input
                            type="checkbox"
                            id="layer-aleppo-city"
                            checked
                          />
                        </div>
                        <div class="layer-icon">
                          <i
                            class="fas fa-vector-square"
                            style="color: #f59e0b"
                          ></i>
                        </div>
                        <span class="layer-name">حدود مدينة حلب</span>
                        <div class="layer-actions">
                          <button
                            class="layer-action-btn"
                            data-action="style"
                            data-layer="aleppo-city-polygon"
                            title="تنسيق الطبقة"
                          >
                            <i class="fas fa-palette"></i>
                          </button>
                          <button
                            class="layer-action-btn"
                            data-action="table"
                            data-layer="aleppo-city-polygon"
                            title="جدول البيانات"
                          >
                            <i class="fas fa-table"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Service Sectors Layer Group -->
                  <div class="layer-group" data-layer-group="service-sectors">
                    <div class="layer-group-header">
                      <button class="layer-group-toggle" data-expanded="true">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <div class="layer-group-checkbox">
                        <input
                          type="checkbox"
                          id="group-service-sectors"
                          checked
                        />
                      </div>
                      <div class="layer-group-icon">
                        <i class="fas fa-cogs"></i>
                      </div>
                      <span class="layer-group-name">دوائر الخدمات</span>
                      <div class="layer-group-actions">
                        <button
                          class="layer-action-btn"
                          data-action="zoom"
                          data-layer="service-sectors"
                          title="تكبير للطبقة"
                        >
                          <i class="fas fa-search-plus"></i>
                        </button>
                        <button
                          class="layer-action-btn"
                          data-action="properties"
                          data-layer="service-sectors"
                          title="خصائص الطبقة"
                        >
                          <i class="fas fa-info-circle"></i>
                        </button>
                        <button
                          class="layer-drag-handle"
                          title="سحب لإعادة الترتيب"
                        >
                          <i class="fas fa-grip-vertical"></i>
                        </button>
                      </div>
                    </div>

                    <div class="layer-group-content">
                      <!-- Service sectors sub-layers -->
                      <div
                        class="layer-item"
                        data-layer="service-sectors-polygons"
                        draggable="true"
                      >
                        <div class="layer-indent"></div>
                        <div class="layer-checkbox">
                          <input
                            type="checkbox"
                            id="layer-service-sectors-polygons"
                            checked
                          />
                        </div>
                        <div class="layer-icon">
                          <i
                            class="fas fa-vector-square"
                            style="color: #dc2626"
                          ></i>
                        </div>
                        <span class="layer-name">حدود دوائر الخدمات</span>
                        <div class="layer-actions">
                          <button
                            class="layer-action-btn"
                            data-action="style"
                            data-layer="service-sectors-polygons"
                            title="تنسيق الطبقة"
                          >
                            <i class="fas fa-palette"></i>
                          </button>
                          <button
                            class="layer-action-btn"
                            data-action="table"
                            data-layer="service-sectors-polygons"
                            title="جدول البيانات"
                          >
                            <i class="fas fa-table"></i>
                          </button>
                        </div>
                      </div>

                      <div
                        class="layer-item"
                        data-layer="service-sectors-labels"
                        draggable="true"
                      >
                        <div class="layer-indent"></div>
                        <div class="layer-checkbox">
                          <input
                            type="checkbox"
                            id="layer-service-sectors-labels"
                            checked
                          />
                        </div>
                        <div class="layer-icon">
                          <i class="fas fa-font" style="color: #7c3aed"></i>
                        </div>
                        <span class="layer-name">مسميات دوائر الخدمات</span>
                        <div class="layer-actions">
                          <button
                            class="layer-action-btn"
                            data-action="style"
                            data-layer="service-sectors-labels"
                            title="تنسيق النصوص"
                          >
                            <i class="fas fa-text-height"></i>
                          </button>
                          <button
                            class="layer-action-btn"
                            data-action="visibility"
                            data-layer="service-sectors-labels"
                            title="إعدادات الرؤية"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="import-export-header">
              <h4><i class="fas fa-exchange-alt"></i> إدارة البيانات</h4>
            </div>

            <div class="import-export-controls">
              <!-- Import Section -->
              <div class="data-operation-group">
                <h5><i class="fas fa-file-import"></i> استيراد البيانات</h5>
                <div class="import-options">
                  <div class="import-method">
                    <button
                      id="importLayerBtn"
                      class="operation-button import-btn"
                    >
                      <i class="fas fa-upload"></i>
                      <span>استيراد ملف</span>
                    </button>
                    <div class="import-formats">
                      <small
                        >الصيغ المدعومة: GeoJSON, KML, Shapefile, CSV</small
                      >
                    </div>
                  </div>

                  <div class="import-method">
                    <button
                      id="importFromUrlBtn"
                      class="operation-button import-btn"
                    >
                      <i class="fas fa-link"></i>
                      <span>استيراد من رابط</span>
                    </button>
                  </div>

                  <div class="import-method">
                    <button
                      id="importFromServiceBtn"
                      class="operation-button import-btn"
                    >
                      <i class="fas fa-server"></i>
                      <span>استيراد من خدمة</span>
                    </button>
                  </div>
                </div>

                <!-- Hidden file inputs -->
                <input
                  type="file"
                  id="layerFileInput"
                  accept=".geojson,.kml,.shp,.zip,.csv"
                  style="display: none"
                />
                <input
                  type="file"
                  id="multipleFilesInput"
                  accept=".geojson,.kml,.shp,.zip,.csv"
                  multiple
                  style="display: none"
                />
              </div>

              <!-- Export Section -->
              <div class="data-operation-group">
                <h5><i class="fas fa-file-export"></i> تصدير البيانات</h5>
                <div class="export-options">
                  <div class="layer-selector">
                    <label for="exportLayerSelect">اختر الطبقة للتصدير:</label>
                    <select id="exportLayerSelect" class="sidebar-select">
                      <option value="">-- اختر طبقة --</option>
                      <option value="neighborhoods">الأحياء (حدود)</option>
                      <option value="neighborhood-labels">
                        الأحياء (مسميات)
                      </option>
                      <option value="service-sectors">
                        دوائر الخدمات (حدود)
                      </option>
                      <option value="service-sector-labels">
                        دوائر الخدمات (مسميات)
                      </option>
                    </select>
                  </div>

                  <div class="format-selector">
                    <label for="exportFormat">صيغة التصدير:</label>
                    <select id="exportFormat" class="sidebar-select">
                      <option value="geojson">GeoJSON</option>
                      <option value="kml">KML</option>
                      <option value="csv">CSV</option>
                      <option value="shp">Shapefile</option>
                    </select>
                  </div>

                  <div class="export-actions">
                    <button
                      id="exportLayerBtn"
                      class="operation-button export-btn"
                    >
                      <i class="fas fa-download"></i>
                      <span>تصدير الطبقة</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- <div class="sidebar-section">
            <h4>الرموز والألوان</h4>
            <div id="symbolEditor" class="symbol-editor">
              <select
                title="sidebar select"
                id="layerStyleSelect"
                class="sidebar-select"
              >
                <option value="">اختر طبقة...</option>
                <option value="neighborhoods">الأحياء</option>
                <option value="service-sectors">دوائر الخدمات</option>
              </select>

              <div class="style-options" id="styleOptions">
                <div
                  class="style-option"
                  id="neighborhoodColoringSection"
                  style="display: none"
                >
                  <label>تلوين حسب العمود:</label>
                  <select id="colorByColumnSelect" class="sidebar-select">
                    <option value="">اختر عمود...</option>
                  </select>
                  <button id="applyColumnColoringBtn" class="sidebar-button">
                    <i class="fas fa-palette"></i> تطبيق التلوين
                  </button>
                  <div
                    id="colorLegend"
                    class="color-legend"
                    style="display: none"
                  >
                    <h5>مفتاح الألوان:</h5>
                    <div id="legendItems"></div>
                  </div>
                </div>

                <div class="style-option">
                  <label id="colorLabel">اللون:</label>
                  <input
                    title="layer color"
                    type="color"
                    id="layerColor"
                    value="#1e40af"
                  />
                </div>

                <div class="style-option">
                  <label id="opacityLabel">الشفافية:</label>
                  <input
                    title="transparency"
                    type="range"
                    id="layerOpacity"
                    min="0"
                    max="1"
                    step="0.1"
                    value="0.8"
                  />
                  <span id="opacityValue">0.8</span>
                </div>

                <div class="style-option">
                  <label id="lineWeightLabel">سمك الخط:</label>
                  <input
                    title="line weight"
                    type="range"
                    id="layerLineWeight"
                    min="1"
                    max="10"
                    step="1"
                    value="2"
                  />
                  <span id="lineWeightValue">2</span>
                </div>
                <button
                  id="applyStyleBtn"
                  class="sidebar-button"
                  style="
                    background: linear-gradient(
                      135deg,
                      #28a745 0%,
                      #20c997 100%
                    );
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 20px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                    margin-bottom: 10px;
                  "
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(40,167,69,0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(40,167,69,0.3)';"
                >
                  <i class="fas fa-check"></i> تطبيق
                </button>

                <button
                  id="resetStyleBtn"
                  class="sidebar-button"
                  style="
                    background: linear-gradient(
                      135deg,
                      #dc3545 0%,
                      #c82333 100%
                    );
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 20px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
                    width: 100%;
                  "
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(220,53,69,0.3)';"
                >
                  <i class="fas fa-undo"></i> إعادة الضبط
                </button>
              </div>
            </div>
          </div> -->
        </div>
      </aside>

      <!-- Right Sidebar - Analysis and Queries -->
      <aside
        id="rightSidebar"
        class="sidebar right-sidebar"
        style="margin-top: -10px"
      >
        <div class="sidebar-header">
          <h3>التحليلات والاستعلامات</h3>
          <button
            id="pinRightSidebar"
            class="sidebar-pin"
            title="تثبيت القائمة"
          >
            <i class="fas fa-thumbtack"></i>
          </button>
          <button
            title="toggle right sidebar"
            id="toggleRightSidebar"
            class="sidebar-toggle"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
        <!-- Indicador de cierre automático -->
        <div id="rightSidebarAutoCloseIndicator" class="auto-close-indicator">
          <span class="auto-close-countdown"></span>
          <span id="auto-close-message">سيتم الإغلاق تلقائيًا</span>
        </div>
        <div class="sidebar-content" style="margin-bottom: 85px">
          <!-- New section for Urban Effectiveness Calculations -->
          <!-- <div class="sidebar-section">
            <h4 id="urban-effectiveness-title">
              <i class="fas fa-calculator"></i> حساب الفعاليات و الوظائف
              القطاعية
            </h4>

            <div
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 4px solid #28a745;
              "
            >
              <h5
                id="sectoral-functions-title"
                style="color: #495057; margin-bottom: 10px; font-size: 14px"
              >
                <i
                  class="fas fa-chart-area"
                  style="color: #28a745; margin-left: 5px"
                ></i>
                حساب الوظائف القطاعية الحضرية
              </h5>
              <p
                id="sectoral-functions-description"
                style="
                  font-size: 12px;
                  color: #6c757d;
                  margin-bottom: 10px;
                  line-height: 1.4;
                "
              >
                حساب وتحليل الوظائف القطاعية للأحياء الحضرية
              </p>
              <button
                id="sidebar-sectoral-functionality-btn"
                class="sidebar-button"
                onclick="showSectoralFunctionalityCalculation()"
                style="
                  width: 100%;
                  padding: 10px;
                  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(40,167,69,0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(40,167,69,0.3)';"
              >
                <i class="fas fa-chart-area"></i>
                <span id="sectoral-functions-button-text"
                  >فتح حاسبة الوظائف القطاعية</span
                >
              </button>
            </div>

            <div
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 4px solid #007bff;
              "
            >
              <h5
                id="abstract-effectiveness-title"
                style="color: #495057; margin-bottom: 10px; font-size: 14px"
              >
                <i
                  class="fas fa-sliders"
                  style="color: #007bff; margin-left: 5px"
                ></i>
                الفعالية العمرانية المجردة
              </h5>
              <p
                id="abstract-effectiveness-description"
                style="
                  font-size: 12px;
                  color: #6c757d;
                  margin-bottom: 10px;
                  line-height: 1.4;
                "
              >
                حساب الفعالية المركبة باستخدام 10 مكونات قطاعية
              </p>
              <button
                id="sidebar-abstract-effectiveness-btn"
                class="sidebar-button"
                onclick="showFullscreenPopup()"
                style="
                  width: 100%;
                  padding: 10px;
                  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,123,255,0.3)';"
              >
                <i class="fas fa-sliders"></i>
                <span id="abstract-effectiveness-button-text"
                  >فتح حاسبة الفعالية المجردة</span
                >
              </button>
            </div>

            <div
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                border-left: 4px solid #6f42c1;
              "
            >
              <h5
                id="final-effectiveness-title"
                style="color: #495057; margin-bottom: 10px; font-size: 14px"
              >
                <i
                  class="fas fa-chart-line"
                  style="color: #6f42c1; margin-left: 5px"
                ></i>
                الفعالية العمرانية النهائية
              </h5>
              <p
                id="final-effectiveness-description"
                style="
                  font-size: 12px;
                  color: #6c757d;
                  margin-bottom: 10px;
                  line-height: 1.4;
                "
              >
                حساب الفعالية النهائية من مكونين: التغيرات السكانية + الفعالية
                المجردة
              </p>
              <button
                id="sidebar-final-effectiveness-btn"
                class="sidebar-button"
                onclick="showFinalUrbanEffectivenessPopup()"
                style="
                  width: 100%;
                  padding: 10px;
                  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(111,66,193,0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(111,66,193,0.3)';"
              >
                <i class="fas fa-chart-line"></i>
                <span id="final-effectiveness-button-text"
                  >فتح حاسبة الفعالية النهائية</span
                >
              </button>
            </div>
          </div> -->

          <div class="sidebar-section">
            <h4>منشئ الاستعلامات</h4>
            <div id="queryBuilder" class="query-builder">
              <div class="query-builder-row">
                <select
                  title="query table select"
                  id="queryTableSelect"
                  class="sidebar-select"
                >
                  <option value="">اختر طبقة...</option>
                  <option value="neighborhoods" id="query-neighborhoods-option">
                    الأحياء
                  </option>
                  <option
                    value="service-sectors"
                    id="query-service-sectors-option"
                  >
                    دوائر الخدمات
                  </option>
                </select>
              </div>

              <div class="query-builder-row">
                <select
                  title="query field select"
                  id="queryFieldSelect"
                  class="sidebar-select"
                >
                  <option value="">اختر حقل...</option>
                </select>
              </div>

              <div class="query-builder-row">
                <select
                  title="query operator select"
                  id="queryOperatorSelect"
                  class="sidebar-select"
                >
                  <option value="">اختر العملية...</option>
                  <option value="=">=</option>
                  <option value="<>">≠</option>
                  <option value=">">></option>
                  <option value="<"><< /option></option>

                  <option value=">=">≥</option>
                  <option value="<=">≤</option>
                  <option value="like" id="query-contains-option">يحتوي</option>
                </select>
              </div>

              <div class="query-builder-row">
                <div class="value-input-container">
                  <input
                    type="text"
                    id="queryValueInput"
                    class="sidebar-input"
                    placeholder="أدخل القيمة"
                  />
                  <button
                    title="value list btn"
                    id="valueListBtn"
                    class="sidebar-button small-button"
                    style="
                      background: linear-gradient(
                        135deg,
                        #007bff 0%,
                        #0056b3 100%
                      );
                      color: white;
                      border: none;
                      border-radius: 8px;
                      padding: 8px 12px;
                      font-weight: 600;
                      transition: all 0.3s ease;
                      box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
                    "
                    onmouseover="this.style.transform='translateY(-1px) scale(1.05)'; this.style.boxShadow='0 4px 10px rgba(0,123,255,0.4)';"
                    onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 2px 6px rgba(0,123,255,0.3)';"
                  >
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>

              <button
                id="addConditionBtn"
                class="sidebar-button"
                style="
                  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
                  color: #212529;
                  border: none;
                  border-radius: 8px;
                  padding: 10px 18px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(255,193,7,0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(255,193,7,0.3)';"
              >
                <i class="fas fa-plus"></i> إضافة شرط
              </button>

              <div id="queryConditions" class="query-conditions"></div>

              <button
                id="runQueryBtn"
                class="sidebar-button primary-button"
                style="
                  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  padding: 12px 20px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                "
                onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 6px 15px rgba(23,162,184,0.4)';"
                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 3px 8px rgba(23,162,184,0.3)';"
              >
                <i class="fas fa-play"></i> تنفيذ الاستعلام
              </button>
            </div>
          </div>

          <div class="sidebar-section">
            <div id="queryResults" class="query-results">
              <div class="empty-state">
                قم بإنشاء استعلام وتنفيذه لعرض النتائج
              </div>
            </div>
          </div>

          <!-- <div class="sidebar-section">


            <div
              id="buffer-analysis-section"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 4px solid #dc3545;
              "
            >
              <h4 style="color: #495057; margin-bottom: 15px; font-size: 16px">
                <i
                  class="fas fa-circle-dot"
                  style="color: #dc3545; margin-left: 5px"
                ></i>
                <span id="buffer-analysis-title">تحليل النطاق (Buffer)</span>
              </h4>
              <div style="margin-bottom: 15px">
                <label
                  for="buffer-radius-km"
                  style="
                    display: block;
                    margin-bottom: 5px;
                    font-weight: 600;
                    color: #495057;
                    font-size: 14px;
                  "
                  id="buffer-radius-label"
                  >نصف القطر (بالكيلومتر):</label
                >
                <input
                  type="number"
                  id="buffer-radius-km"
                  value="1"
                  min="0.1"
                  step="0.1"
                  style="
                    width: 100%;
                    padding: 8px 12px;
                    border: 2px solid #e9ecef;
                    border-radius: 6px;
                    font-size: 14px;
                    transition: border-color 0.3s ease;
                  "
                  onfocus="this.style.borderColor='#dc3545';"
                  onblur="this.style.borderColor='#e9ecef';"
                />
              </div>

              <button
                id="select-center-btn"
                style="
                  width: 100%;
                  padding: 10px 15px;
                  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  margin-bottom: 10px;
                  transition: all 0.3s ease;
                  box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
                "
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(220,53,69,0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(220,53,69,0.3)';"
              >
                <i class="fas fa-crosshairs"></i>
                <span id="select-center-btn-text"
                  >1. تحديد المركز على الخريطة</span
                >
              </button>

              <button
                id="run-analysis-btn"
                disabled
                style="
                  width: 100%;
                  padding: 10px 15px;
                  background: #6c757d;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  cursor: not-allowed;
                  opacity: 0.6;
                "
              >
                <i class="fas fa-chart-area"></i>
                <span id="run-analysis-btn-text">2. حساب تقرير النطاق</span>
              </button>
            </div>
          </div> -->
        </div>
      </aside>
    </div>

    <!-- Buffer Analysis Report Modal -->
    <div
      id="report-modal"
      class="modal-hidden"
      style="
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      "
    >
      <div
        class="modal-content"
        style="
          position: relative;
          background-color: #fff;
          margin: 5% auto;
          padding: 0;
          border-radius: 12px;
          width: 90%;
          max-width: 600px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease-out;
        "
      >
        <div
          style="
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            position: relative;
          "
        >
          <h4 style="margin: 0; font-size: 18px; font-weight: 600">
            <i class="fas fa-chart-area" style="margin-left: 8px"></i>
            <span id="report-modal-title">نتائج تحليل النطاق</span>
          </h4>
          <span
            class="close-button"
            style="
              position: absolute;
              top: 15px;
              left: 20px;
              color: white;
              font-size: 24px;
              font-weight: bold;
              cursor: pointer;
              transition: color 0.3s ease;
            "
            onmouseover="this.style.color='#ffcccc';"
            onmouseout="this.style.color='white';"
            >&times;</span
          >
        </div>
        <div
          id="report-results"
          style="
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
          "
        ></div>
      </div>
    </div>

    <!-- Footer -->
    <footer id="mainFooter" class="no-translate" style="font-size: 12px">
      <div class="footer-content">
        <div class="copyright" style="font-size: 12px">
          <span class="copyright-text">
            ©
            <script>
              document.write(new Date().getFullYear());
            </script>
            , <span id="rightsText">Powerd by</span>
            <a
              rel="noopener"
              class="companyHITech"
              href="https://www.hi-techhouse.com"
              target="_blank"
              id="companyName"
              >HI-Tech House</a
            >
          </span>
          <!-- <img
            alt="Company Logo"
            src="assets/img/HTH.png"
            class="footer-logo"
          /> -->
        </div>

        <!-- New centralized tabs toggle button -->
        <div class="footer-center-btn">
          <!-- Button removed since it's now in the toolbar -->
        </div>

        <div class="social-icons">
          <a aria-label="Facebook" class="social-icon facebook" href="#"
            ><i class="fab fa-facebook-f"></i
          ></a>
          <a aria-label="Twitter" class="social-icon twitter" href="#"
            ><i class="fab fa-x-twitter"></i
          ></a>
          <a aria-label="Instagram" class="social-icon instagram" href="#"
            ><i class="fab fa-instagram"></i
          ></a>
          <a aria-label="LinkedIn" class="social-icon linkedin" href="#"
            ><i class="fab fa-linkedin-in"></i
          ></a>
          <a
            aria-label="WhatsApp"
            class="social-icon whatsapp"
            href="https://wa.me/966501234567"
            ><i class="fab fa-whatsapp"></i
          ></a>
        </div>
      </div>
    </footer>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>

    <!-- Aleppo City Data -->
    <script src="js/aleppo-data.js"></script>
    <!-- shpjs for Shapefile import -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

    <!-- Leaflet Plugins -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <!-- Leaflet Measure JS -->
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>

    <!-- Turf.js for spatial analysis -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Application Data & Scripts -->
    <script src="js/main.js"></script>
    <script src="js/service-sectors.js"></script>
    <script src="attached_assets/aleppo-data.js"></script>
    <script src="attached_assets/neighborhoods-data.js"></script>
    <script src="attached_assets/aleppo-analysis.js"></script>
    <script src="js/field-translations.js"></script>
    <script src="js/sidebar.js"></script>
    <script>
      // Add needed modifications to existing sidebar auto-close functionality
      if (typeof window.initSidebarAutoClose !== "function") {
        // Define a function to initialize sidebar auto-close if it doesn't exist yet
        window.initSidebarAutoClose = function () {
          // Auto-close functionality for sidebars
          window.showAutoCloseIndicator = function (sidebarId) {
            const sidebar = document.getElementById(sidebarId);
            if (sidebar && sidebar.getAttribute("data-pinned") === "true") {
              // Don't auto-close if pinned
              return;
            }

            const indicatorId = sidebarId + "AutoCloseIndicator";
            const indicator = document.getElementById(indicatorId);

            if (indicator) {
              indicator.classList.add("show");

              // Store the timer reference
              const timerProp =
                sidebarId === "leftSidebar"
                  ? "leftSidebarAutoCloseTimer"
                  : "rightSidebarAutoCloseTimer";

              // Clear existing timer if any
              if (window[timerProp]) {
                clearTimeout(window[timerProp]);
              }

              // Set new timer
              window[timerProp] = setTimeout(function () {
                // Check pinned state again before closing
                if (sidebar && sidebar.getAttribute("data-pinned") !== "true") {
                  indicator.classList.remove("show");
                  sidebar.classList.add("collapsed");
                }
              }, 5000); // 5 second auto-close delay
            }
          };
        };

        // Initialize
        window.initSidebarAutoClose();
      }

      // Pin sidebar functionality
      document.addEventListener("DOMContentLoaded", function () {
        const pinLeftButton = document.getElementById("pinLeftSidebar");
        const pinRightButton = document.getElementById("pinRightSidebar");
        const leftSidebar = document.getElementById("leftSidebar");
        const rightSidebar = document.getElementById("rightSidebar");

        // Set initial pinned state
        leftSidebar.setAttribute("data-pinned", "false");
        rightSidebar.setAttribute("data-pinned", "false");

        // Pin left sidebar
        pinLeftButton.addEventListener("click", function () {
          const isPinned = leftSidebar.getAttribute("data-pinned") === "true";
          leftSidebar.setAttribute("data-pinned", !isPinned);
          this.classList.toggle("active", !isPinned);

          // If pinned, hide auto-close indicator
          const autoCloseIndicator = document.getElementById(
            "leftSidebarAutoCloseIndicator"
          );
          if (autoCloseIndicator) {
            if (!isPinned) {
              autoCloseIndicator.classList.remove("show");
              // Clear any auto-close timers if they exist
              if (window.leftSidebarAutoCloseTimer) {
                clearTimeout(window.leftSidebarAutoCloseTimer);
              }
            }
          }
        });

        // Pin right sidebar
        pinRightButton.addEventListener("click", function () {
          const isPinned = rightSidebar.getAttribute("data-pinned") === "true";
          rightSidebar.setAttribute("data-pinned", !isPinned);
          this.classList.toggle("active", !isPinned);

          // If pinned, hide auto-close indicator
          const autoCloseIndicator = document.getElementById(
            "rightSidebarAutoCloseIndicator"
          );
          if (autoCloseIndicator) {
            if (!isPinned) {
              autoCloseIndicator.classList.remove("show");
              // Clear any auto-close timers if they exist
              if (window.rightSidebarAutoCloseTimer) {
                clearTimeout(window.rightSidebarAutoCloseTimer);
              }
            }
          }
        });
      });
    </script>
    <script src="js/map.js"></script>
    <script src="js/exportReportPDF.js"></script>
    <script src="js/query.js"></script>
    <script src="js/hydraulic-billing.js"></script>
    <script src="js/import-export.js"></script>
    <script src="js/features.js"></script>
    <script src="js/tabs2.js"></script>
    <script src="js/info-panel-formatter.js"></script>
    <script src="js/advanced-layer-manager.js"></script>
    <script src="js/buffer-analysis.js"></script>
    <script>
      // Map Information Bar Update Functions
      function updateMapInfoBar() {
        if (!window.map || typeof window.map.getCenter !== "function") return;

        // Get current map state
        const center = window.map.getCenter();
        const zoom = window.map.getZoom();

        // Calculate approximate scale based on zoom level
        // Formula: scale = 591657527.591555 / (2^zoom)
        const scale = Math.round(591657527.591555 / Math.pow(2, zoom));

        // Format coordinates (limit to 6 decimal places)
        const lat = center.lat.toFixed(6);
        const lng = center.lng.toFixed(6);

        // Get current language
        const currentLang = document.documentElement.lang || "ar";
        const t = window.translations[currentLang];

        // Update DOM elements with localized text - always use English numbers
        const scaleElement = document.getElementById("map-scale");
        const centerElement = document.getElementById("map-center");

        if (scaleElement && t && t.mapInfo) {
          // Always use English numbers format
          scaleElement.textContent = `${
            t.mapInfo.scale
          }: 1:${scale.toLocaleString("en-US")}`;
        }

        if (centerElement && t && t.mapInfo) {
          // Coordinates are already in English numbers format
          centerElement.textContent = `${t.mapInfo.center}: ${lat}, ${lng}`;
        }
      }

      // Initialize map info bar when map is ready
      document.addEventListener("DOMContentLoaded", function () {
        // Wait for map to be initialized
        const checkMapReady = setInterval(function () {
          if (
            window.map &&
            typeof window.map.on === "function" &&
            typeof window.map.getCenter === "function"
          ) {
            clearInterval(checkMapReady);

            // Initial update
            updateMapInfoBar();

            // Listen for map events
            window.map.on("moveend", updateMapInfoBar);
            window.map.on("zoomend", updateMapInfoBar);
            window.map.on("resize", updateMapInfoBar);
          }
        }, 100);
      });

      // Fix for white space issue when clicking on the map
      document.addEventListener("click", function (e) {
        if (e.target && (e.target.id === "map" || e.target.closest("#map"))) {
          setTimeout(function () {
            if (window.map && typeof window.map.invalidateSize === "function") {
              window.map.invalidateSize(true);
            }
          }, 100);
        }
      });

      // Make translations available globally
      window.translations = {
        ar: {
          title: "نظام الإدارة الحضرية لمدينة حلب",
          settingsText: "إعدادات الحساب",
          logoutText: "تسجيل الخروج",
          rightsText: "Powerd by",
          companyName: "HI-Tech House",
          // Info panel buttons
          cancelChanges: "إلغاء التعديلات",
          saveChanges: "حفظ التغييرات",
          nextTab: "التالي",
          browseBtn: "استعراض",
          saveAllData: "تحديث جميع البيانات",
          saveAllWarning:
            "سيتم حفظ جميع التغييرات بشكل دائم. هل أنت متأكد من المتابعة؟",
          continue: "متابعة",
          cancel: "إلغاء",
          successMessage: "تم تحديث جميع البيانات بنجاح!",
          // Tab names
          tabs: {
            التدخلات_الإنسانية: "التدخلات الإنسانية",
            الأسواق_الأساسية: "الأسواق الأساسية",
            إدارة_النفايات_الصلبة: "إدارة النفايات الصلبة",

            شبكة_الكهرباء: "شبكة الكهرباء",
            شبكة_الاتصالات: "شبكة الاتصالات",
            إمدادات_المياه: "إمدادات المياه",
            شبكة_الصرف_الصحي: "شبكة الصرف الصحي",
            أضرار_الإسكان: "الضرر الفيزيائي",
            النسيج_الحضري: "النسيج الحضري",
            التغيرات_السكانية: "التغيرات السكانية",
            "أعضاء لجنة الحي": "أعضاء لجنة الحي",
            "معلومات التواصل مع لجنة الحي": "معلومات التواصل مع لجنة الحي",
            لجان_التنمية: "لجان التنمية",
          },
          // Sidebar labels
          sidebar: {
            layersManagement: "إدارة الطبقات",
            baseMaps: "الخرائط الأساسية",
            openStreetMap: "خريطة الشارع المفتوحة",
            satellite: "صور الأقمار الصناعية",
            terrain: "التضاريس",
            layers: "الطبقات",
            neighborhoods: "الأحياء",
            serviceSectors: "دوائر الخدمات",
            importExport: "إدارة البيانات",
            importLayer: "استيراد ملف",
            exportLayer: "تصدير الطبقة",
            exportFormat: "صيغة التصدير",
            symbolsColors: "الرموز والألوان",
            chooseLayer: "اختر طبقة...",
            color: "اللون:",
            transparency: "الشفافية:",
            lineWeight: "سمك الخط:",
            apply: "تطبيق",
            reset: "إعادة الضبط",
            // Layer management translations
            mainLayers: "الطبقات الرئيسية",
            neighborhoodsBoundaries: "حدود الأحياء",
            neighborhoodsLabels: "مسميات الأحياء",
            serviceSectorsBoundaries: "حدود دوائر الخدمات",
            serviceSectorsLabels: "مسميات دوائر الخدمات",
            zoomToLayers: "تكبير للطبقات",
            zoomToLayer: "تكبير للطبقة",
            groupProperties: "خصائص المجموعة",
            layerProperties: "خصائص الطبقة",
            dragToReorder: "سحب لإعادة الترتيب",
            styleLayer: "تنسيق الطبقة",
            dataTable: "جدول البيانات",
            textFormatting: "تنسيق النصوص",
            visibilitySettings: "إعدادات الرؤية",
            autoCloseMessage: "سيتم الإغلاق تلقائيًا",
            pinSidebar: "تثبيت القائمة",
            // Import/Export section
            dataManagement: "إدارة البيانات",
            importData: "استيراد البيانات",
            exportData: "تصدير البيانات",
            importFile: "استيراد ملف",
            importFromUrl: "استيراد من رابط",
            importFromService: "استيراد من خدمة",
            supportedFormats: "الصيغ المدعومة",
            chooseLayerExport: "اختر الطبقة للتصدير:",
            selectLayer: "-- اختر طبقة --",
            exportFormat: "صيغة التصدير:",
            // Style section
            colorByColumn: "تلوين حسب العمود:",
            selectColumn: "اختر عمود...",
            applyColoring: "تطبيق التلوين",
            colorLegend: "مفتاح الألوان:",
          },
          // Map info bar labels
          mapInfo: {
            scale: "المقياس",
            center: "المركز",
          },
          // Urban Effectiveness Calculations
          urbanEffectiveness: {
            title: "حساب الفعاليات و الوظائف القطاعية",
            sectoralFunctions: {
              title: "حساب الوظائف القطاعية الحضرية",
              description: "حساب وتحليل الوظائف القطاعية للأحياء الحضرية",
              buttonText: "فتح حاسبة الوظائف القطاعية",
            },
            abstractEffectiveness: {
              title: "الفعالية العمرانية المجردة",
              description: "حساب الفعالية المركبة باستخدام 10 مكونات قطاعية",
              buttonText: "فتح حاسبة الفعالية المجردة",
            },
            finalEffectiveness: {
              title: "الفعالية العمرانية النهائية",
              description:
                "حساب الفعالية النهائية من مكونين: التغيرات السكانية + الفعالية المجردة",
              buttonText: "فتح حاسبة الفعالية النهائية",
            },
          },
          // Right sidebar
          analysisQueries: {
            title: "التحليلات والاستعلامات",
            queryBuilder: "منشئ الاستعلامات",
            chooseLayer: "اختر طبقة...",
            chooseField: "اختر حقل...",
            chooseOperation: "اختر العملية...",
            enterValue: "أدخل القيمة",
            addCondition: "إضافة شرط",
            runQuery: "تنفيذ الاستعلام",
            createQueryMessage: "قم بإنشاء استعلام وتنفيذه لعرض النتائج",
            // Query options
            neighborhoods: "الأحياء",
            serviceSectors: "دوائر الخدمات",
            contains: "يحتوي",
            // Auto-close indicator
            autoCloseMessage: "سيتم الإغلاق تلقائيًا",
            // Pin button
            pinSidebar: "تثبيت القائمة",
            // Additional query-related translations
            equal: "يساوي",
            notEqual: "لا يساوي",
            greaterThan: "أكبر من",
            lessThan: "أصغر من",
            greaterThanOrEqual: "أكبر من أو يساوي",
            lessThanOrEqual: "أصغر من أو يساوي",
            valueList: "قائمة القيم",
            selectValue: "اختر قيمة",
          },
          // Neighborhood Report
          neighborhoodReport: {
            title: "إنشاء تقرير عن الحي",
            chooseNeighborhood: "اختر الحي للتقرير:",
            selectNeighborhood: "-- اختر حي --",
            reportOptions: "خيارات التقرير",
            includeMap: "تضمين خريطة الحي",
            includeInfo: "معلومات الحي التفصيلية",
            includeSectoral: "الوظائف القطاعية الحضرية",
            includeDamage: "نسب الأضرار",
            exportButton: "تصدير تقرير PDF",
            exportingButton: "جاري إنشاء التقرير...",
            selectNeighborhoodFirst: "يرجى اختيار حي أولاً",
            neighborhoodNotFound: "لم يتم العثور على بيانات الحي المحدد",
            exportSuccess: "تم تصدير التقرير بنجاح! تحقق من مجلد التنزيلات",
            exportError: "حدث خطأ أثناء إنشاء التقرير. يرجى المحاولة مرة أخرى",
          },
          // Buffer Analysis
          bufferAnalysis: {
            sectionTitle: "التحليل المكاني",
            title: "تحليل النطاق (Buffer)",
            radiusLabel: "نصف القطر (بالكيلومتر):",
            selectCenterBtn: "1. تحديد المركز على الخريطة",
            selectingCenterBtn: "انقر على الخريطة لتحديد المركز",
            centerSelectedBtn: "تم تحديد المركز",
            runAnalysisBtn: "2. حساب تقرير النطاق",
            reportTitle: "نتائج تحليل النطاق",
            closeBtn: "إغلاق",
            noNeighborhoodsFound: "لا توجد أحياء ضمن النطاق المحدد",
            radiusInfo: "نصف القطر المحدد",
            tryDifferent: "جرب زيادة نصف القطر أو تغيير المركز",
            analysisSummary: "ملخص التحليل",
            radius: "نصف القطر",
            neighborhoodsCount: "عدد الأحياء",
            intersectingNeighborhoods: "الأحياء المتقاطعة مع النطاق:",
            newAnalysisBtn: "إجراء تحليل جديد",
            selectCenterFirst: "يرجى تحديد المركز أولاً",
            layerNotAvailable: "طبقة الأحياء غير متوفرة",
            kilometer: "كيلومتر",
          },
          // Map controls
          mapControls: {
            layers: "الطبقات",
          },
        },
        en: {
          title: "Urban Management System for Aleppo",
          settingsText: "Account Settings",
          logoutText: "Logout",
          rightsText: "Powerd by",
          companyName: "Hi-Tech House",
          // Info panel buttons
          cancelChanges: "Cancel Changes",
          saveChanges: "Save Changes",
          nextTab: "Next",
          browseBtn: "Browse",
          saveAllData: "Update All Data",
          saveAllWarning:
            "All changes will be saved permanently. Are you sure you want to continue?",
          continue: "Continue",
          cancel: "Cancel",
          successMessage: "All data saved successfully!",
          // Tab names
          tabs: {
            التدخلات_الإنسانية: "Humanitarian Interventions",
            الأسواق_الأساسية: "Basic Markets",
            إدارة_النفايات_الصلبة: "Solid Waste Management",

            شبكة_الكهرباء: "Electricity Network",
            شبكة_الاتصالات: "Communications Network",
            إمدادات_المياه: "Water Supply",
            شبكة_الصرف_الصحي: "Sewage Network",
            أضرار_الإسكان: "Physical Damage",
            النسيج_الحضري: "Urban Fabric",
            التغيرات_السكانية: "Population Changes",
            "أعضاء لجنة الحي": "Neighborhood Committee Members",
            "معلومات التواصل مع لجنة الحي":
              "Neighborhood Committee Contact Info",
            لجان_التنمية: "Development Committees",
          },
          // Sidebar labels
          sidebar: {
            layersManagement: "Layers Management",
            baseMaps: "Base Maps",
            openStreetMap: "OpenStreetMap",
            satellite: "Satellite Imagery",
            terrain: "Terrain",
            layers: "Layers",
            neighborhoods: "Neighborhoods",
            serviceSectors: "Service Sectors",
            importExport: "Data Management",
            importLayer: "Import File",
            exportLayer: "Export Layer",
            exportFormat: "Export Format",
            symbolsColors: "Symbols and Colors",
            chooseLayer: "Choose Layer...",
            color: "Color:",
            transparency: "Transparency:",
            lineWeight: "Line Weight:",
            apply: "Apply",
            reset: "Reset",
            // Layer management translations
            mainLayers: "Main Layers",
            neighborhoodsBoundaries: "Neighborhood Boundaries",
            neighborhoodsLabels: "Neighborhood Labels",
            serviceSectorsBoundaries: "Service Sectors Boundaries",
            serviceSectorsLabels: "Service Sectors Labels",
            zoomToLayers: "Zoom to Layers",
            zoomToLayer: "Zoom to Layer",
            groupProperties: "Group Properties",
            layerProperties: "Layer Properties",
            dragToReorder: "Drag to Reorder",
            styleLayer: "Style Layer",
            dataTable: "Data Table",
            textFormatting: "Text Formatting",
            visibilitySettings: "Visibility Settings",
            autoCloseMessage: "Will close automatically",
            pinSidebar: "Pin sidebar",
            // Import/Export section
            dataManagement: "Data Management",
            importData: "Import Data",
            exportData: "Export Data",
            importFile: "Import File",
            importFromUrl: "Import from URL",
            importFromService: "Import from Service",
            supportedFormats: "Supported Formats",
            chooseLayerExport: "Choose layer to export:",
            selectLayer: "-- Select Layer --",
            exportFormat: "Export Format:",
            // Style section
            colorByColumn: "Color by Column:",
            selectColumn: "Select Column...",
            applyColoring: "Apply Coloring",
            colorLegend: "Color Legend:",
          },
          // Map info bar labels
          mapInfo: {
            scale: "Scale",
            center: "Center",
          },
          // Urban Effectiveness Calculations
          urbanEffectiveness: {
            title: "Effectiveness and Sectoral Functions Calculation",
            sectoralFunctions: {
              title: "Urban Sectoral Functions Calculation",
              description:
                "Calculate and analyze sectoral functions for urban neighborhoods",
              buttonText: "Open Sectoral Functions Calculator",
            },
            abstractEffectiveness: {
              title: "Abstract Urban Effectiveness",
              description:
                "Calculate composite effectiveness using 10 sectoral components",
              buttonText: "Open Abstract Effectiveness Calculator",
            },
            finalEffectiveness: {
              title: "Final Urban Effectiveness",
              description:
                "Calculate final effectiveness from two components: Population Changes + Abstract Effectiveness",
              buttonText: "Open Final Effectiveness Calculator",
            },
          },
          // Right sidebar
          analysisQueries: {
            title: "Analysis and Queries",
            queryBuilder: "Query Builder",
            chooseLayer: "Choose Layer...",
            chooseField: "Choose Field...",
            chooseOperation: "Choose Operation...",
            enterValue: "Enter Value",
            addCondition: "Add Condition",
            runQuery: "Run Query",
            createQueryMessage: "Create and run a query to view results",
            // Query options
            neighborhoods: "Neighborhoods",
            serviceSectors: "Service Sectors",
            contains: "Contains",
            // Auto-close indicator
            autoCloseMessage: "Will close automatically",
            // Pin button
            pinSidebar: "Pin sidebar",
            // Additional query-related translations
            equal: "Equals",
            notEqual: "Not Equal",
            greaterThan: "Greater Than",
            lessThan: "Less Than",
            greaterThanOrEqual: "Greater Than or Equal",
            lessThanOrEqual: "Less Than or Equal",
            valueList: "Value List",
            selectValue: "Select Value",
          },
          // Neighborhood Report
          neighborhoodReport: {
            title: "Generate Neighborhood Report",
            chooseNeighborhood: "Choose neighborhood for report:",
            selectNeighborhood: "-- Select Neighborhood --",
            reportOptions: "Report Options",
            includeMap: "Include neighborhood map",
            includeInfo: "Detailed neighborhood information",
            includeSectoral: "Urban sectoral functions",
            includeDamage: "Damage ratios",
            exportButton: "Export PDF Report",
            exportingButton: "Generating report...",
            selectNeighborhoodFirst: "Please select a neighborhood first",
            neighborhoodNotFound: "Neighborhood data not found",
            exportSuccess:
              "Report exported successfully! Check your downloads folder",
            exportError: "Error generating report. Please try again",
          },
          // Buffer Analysis
          bufferAnalysis: {
            sectionTitle: "Spatial Analysis",
            title: "Buffer Analysis",
            radiusLabel: "Radius (in kilometers):",
            selectCenterBtn: "1. Select Center on Map",
            selectingCenterBtn: "Click on map to select center",
            centerSelectedBtn: "Center Selected",
            runAnalysisBtn: "2. Calculate Buffer Report",
            reportTitle: "Buffer Analysis Results",
            closeBtn: "Close",
            noNeighborhoodsFound:
              "No neighborhoods found within the specified buffer",
            radiusInfo: "Specified radius",
            tryDifferent: "Try increasing the radius or changing the center",
            analysisSummary: "Analysis Summary",
            radius: "Radius",
            neighborhoodsCount: "Number of Neighborhoods",
            intersectingNeighborhoods:
              "Neighborhoods intersecting with buffer:",
            newAnalysisBtn: "Perform New Analysis",
            selectCenterFirst: "Please select center first",
            layerNotAvailable: "Neighborhoods layer not available",
            kilometer: "kilometer",
          },
          // Map controls
          mapControls: {
            layers: "Layers",
          },
        },
      };

      // Make translations available globally
      window.translations = translations;

      function toggleLanguage() {
        // switch language between arabic and english
        const currentLang = document.documentElement.lang || "ar";
        const newLang = currentLang === "ar" ? "en" : "ar";
        switchLanguage(newLang);

        // update language toggle button text
        const langToggleBtn = document.getElementById("langToggleBtn");
        if (langToggleBtn) {
          langToggleBtn.textContent = newLang.toUpperCase();
        }

        // save selected language in local storage
        localStorage.setItem("selectedLanguage", newLang);
      }

      function switchLanguage(lang) {
        // change page direction
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";

        // Apply fixed direction to no-translate elements
        document.querySelectorAll(".no-translate").forEach((element) => {
          // Keep header and footer with fixed direction regardless of language
          element.style.direction = "rtl"; // Always keep RTL for header and footer

          // Ensure the layout doesn't change when switching languages
          if (element.id === "mainHeader") {
            // Fix header elements
            const rightLogos = element.querySelector(
              ".header-logos.right-logos"
            );
            const leftControls = element.querySelector("div:first-child");
            const title = element.querySelector(".header-title");

            if (rightLogos) rightLogos.style.right = "20px";
            if (leftControls) leftControls.style.left = "20px";
            if (title) {
              title.style.left = "50%";
              title.style.transform = "translateX(-50%)";
            }
          } else if (element.id === "mainFooter") {
            // Fix footer elements
            const copyright = element.querySelector(".copyright");
            const socialIcons = element.querySelector(".social-icons");

            if (copyright) copyright.style.left = "20px";
            if (socialIcons) socialIcons.style.right = "20px";
          }
        });

        // Ensure map-toolbar, drawing-tools-toolbar, measurement-tools-toolbar and tabs-container maintain RTL direction
        document
          .querySelectorAll(
            ".map-toolbar, .drawing-tools-toolbar, .measurement-tools-toolbar, .tabs-container"
          )
          .forEach((element) => {
            element.style.direction = "rtl";
          });

        // تحديث النصوص
        const t = window.translations[lang];
        //document.title = t.title;

        // Skip translation for elements with no-translate class
        const noTranslateElements = document.querySelectorAll(".no-translate");

        // update menu - only if not in a no-translate container
        const settingsText = document.getElementById("settingsText");
        const logoutText = document.getElementById("logoutText");

        // update footer - only if not in a no-translate container
        const rightsText = document.getElementById("rightsText");
        const companyName = document.getElementById("companyName");

        // update titles - only if not in a no-translate container
        const titleAr = document.querySelector(".title-ar");
        const titleEn = document.querySelector(".title-en");

        // update tab names
        if (t.tabs) {
          document.querySelectorAll(".tab-button").forEach((button) => {
            if (isInNoTranslateContainer(button)) return;

            const tabId = button.getAttribute("data-tab");
            const tabSpan = button.querySelector("span:not(.tab-close)");
            if (tabSpan && tabId && t.tabs[tabId]) {
              tabSpan.textContent = t.tabs[tabId];
            }
          });
        }

        // update layers toggle button text
        const layersToggleAfter = document.querySelector(
          ".leaflet-control-layers-toggle::after"
        );
        if (
          layersToggleAfter &&
          t.mapControls &&
          t.mapControls.layers &&
          !isInNoTranslateContainer(layersToggleAfter)
        ) {
          document.documentElement.style.setProperty(
            "--layers-text",
            `"${t.mapControls.layers}"`
          );
        }

        // update sidebar elements
        if (t.sidebar) {
          // sidebar titles with smooth transition
          const layersManagementTitle = document.querySelector(
            "#leftSidebar .sidebar-header h3"
          );
          if (
            layersManagementTitle &&
            !isInNoTranslateContainer(layersManagementTitle)
          ) {
            // Add transition class
            layersManagementTitle.classList.add("language-transition");

            setTimeout(() => {
              layersManagementTitle.textContent = t.sidebar.layersManagement;
              layersManagementTitle.classList.remove("language-transition");
            }, 150);
          }

          // Update layers management header
          const layersManagementHeader =
            document.querySelector(".layers-header h4");
          if (layersManagementHeader) {
            const iconElement = layersManagementHeader.querySelector("i");
            layersManagementHeader.innerHTML = "";
            if (iconElement) layersManagementHeader.appendChild(iconElement);
            layersManagementHeader.appendChild(
              document.createTextNode(" " + t.sidebar.layersManagement)
            );
          }

          // Update layer group names and tooltips
          const mainLayersGroupName = document.querySelector(
            '[data-layer-group="main-layers"] .layer-group-name'
          );
          if (mainLayersGroupName) {
            mainLayersGroupName.textContent = t.sidebar.mainLayers;
          }

          const neighborhoodsGroupName = document.querySelector(
            '[data-layer-group="neighborhoods"] .layer-group-name'
          );
          if (neighborhoodsGroupName) {
            neighborhoodsGroupName.textContent = t.sidebar.neighborhoods;
          }

          const serviceGroupName = document.querySelector(
            '[data-layer-group="service-sectors"] .layer-group-name'
          );
          if (serviceGroupName) {
            serviceGroupName.textContent = t.sidebar.serviceSectors;
          }

          // Update layer names
          const neighborhoodsBoundariesLayer = document.querySelector(
            '[data-layer="neighborhoods-polygons"] .layer-name'
          );
          if (neighborhoodsBoundariesLayer) {
            neighborhoodsBoundariesLayer.textContent =
              t.sidebar.neighborhoodsBoundaries;
          }

          const neighborhoodsLabelsLayer = document.querySelector(
            '[data-layer="neighborhoods-labels"] .layer-name'
          );
          if (neighborhoodsLabelsLayer) {
            neighborhoodsLabelsLayer.textContent =
              t.sidebar.neighborhoodsLabels;
          }

          const serviceSectorsBoundariesLayer = document.querySelector(
            '[data-layer="service-sectors-polygons"] .layer-name'
          );
          if (serviceSectorsBoundariesLayer) {
            serviceSectorsBoundariesLayer.textContent =
              t.sidebar.serviceSectorsBoundaries;
          }

          const serviceSectorsLabelsLayer = document.querySelector(
            '[data-layer="service-sectors-labels"] .layer-name'
          );
          if (serviceSectorsLabelsLayer) {
            serviceSectorsLabelsLayer.textContent =
              t.sidebar.serviceSectorsLabels;
          }

          // Update tooltips
          document.querySelectorAll('[title="تكبير للطبقات"]').forEach((el) => {
            el.title = t.sidebar.zoomToLayers;
          });

          document.querySelectorAll('[title="تكبير للطبقة"]').forEach((el) => {
            el.title = t.sidebar.zoomToLayer;
          });

          document
            .querySelectorAll('[title="خصائص المجموعة"]')
            .forEach((el) => {
              el.title = t.sidebar.groupProperties;
            });

          document.querySelectorAll('[title="خصائص الطبقة"]').forEach((el) => {
            el.title = t.sidebar.layerProperties;
          });

          document
            .querySelectorAll('[title="سحب لإعادة الترتيب"]')
            .forEach((el) => {
              el.title = t.sidebar.dragToReorder;
            });

          document.querySelectorAll('[title="تنسيق الطبقة"]').forEach((el) => {
            el.title = t.sidebar.styleLayer;
          });

          document.querySelectorAll('[title="جدول البيانات"]').forEach((el) => {
            el.title = t.sidebar.dataTable;
          });

          document.querySelectorAll('[title="تنسيق النصوص"]').forEach((el) => {
            el.title = t.sidebar.textFormatting;
          });

          document
            .querySelectorAll('[title="إعدادات الرؤية"]')
            .forEach((el) => {
              el.title = t.sidebar.visibilitySettings;
            });

          // base maps title
          const baseMapsTitle = document.querySelector(
            ".sidebar-section-title"
          );
          if (baseMapsTitle) {
            const iconSpan = baseMapsTitle.querySelector("i");
            baseMapsTitle.innerHTML = "";
            if (iconSpan) baseMapsTitle.appendChild(iconSpan);
            baseMapsTitle.appendChild(
              document.createTextNode(t.sidebar.baseMaps)
            );
          }

          // base maps options
          const osmLabel = document.querySelector('label[for="osm"]');
          const satelliteLabel = document.querySelector(
            'label[for="satellite"]'
          );
          const terrainLabel = document.querySelector('label[for="terrain"]');

          if (osmLabel) osmLabel.textContent = t.sidebar.openStreetMap;
          if (satelliteLabel) satelliteLabel.textContent = t.sidebar.satellite;
          if (terrainLabel) terrainLabel.textContent = t.sidebar.terrain;

          // layers title
          const layersTitle = document.querySelector(
            ".sidebar-section h4:not(.sidebar-section-title)"
          );
          if (layersTitle) layersTitle.textContent = t.sidebar.layers;

          // neighborhoods label
          const neighborhoodsLabel = document.querySelector(
            'label[for="layer-neighborhoods"]'
          );
          const serviceSectorsLabel = document.querySelector(
            'label[for="layer-service-sectors"]'
          );

          if (neighborhoodsLabel)
            neighborhoodsLabel.textContent = t.sidebar.neighborhoods;
          if (serviceSectorsLabel)
            serviceSectorsLabel.textContent = t.sidebar.serviceSectors;

          // import/export title
          const importExportTitle = document.querySelector(
            ".import-export-header h4"
          );
          if (importExportTitle) {
            const iconElement = importExportTitle.querySelector("i");
            importExportTitle.innerHTML = "";
            if (iconElement) importExportTitle.appendChild(iconElement);
            importExportTitle.appendChild(
              document.createTextNode(" " + t.sidebar.dataManagement)
            );
          }

          // import data section
          const importDataTitle = document.querySelector(
            ".data-operation-group h5:first-of-type"
          );
          if (importDataTitle) {
            const iconElement = importDataTitle.querySelector("i");
            importDataTitle.innerHTML = "";
            if (iconElement) importDataTitle.appendChild(iconElement);
            importDataTitle.appendChild(
              document.createTextNode(" " + t.sidebar.importData)
            );
          }

          // export data section
          const exportDataTitle = document.querySelector(
            ".data-operation-group:nth-child(2) h5"
          );
          if (exportDataTitle) {
            const iconElement = exportDataTitle.querySelector("i");
            exportDataTitle.innerHTML = "";
            if (iconElement) exportDataTitle.appendChild(iconElement);
            exportDataTitle.appendChild(
              document.createTextNode(" " + t.sidebar.exportData)
            );
          }

          const importLayerBtn = document.getElementById("importLayerBtn");
          const exportLayerBtn = document.getElementById("exportLayerBtn");
          const exportFormatLabel = document.querySelector(
            'label[for="exportFormat"]'
          );

          if (importLayerBtn) {
            const iconElement = importLayerBtn.querySelector("i");
            const spanElement = importLayerBtn.querySelector("span");
            if (spanElement) {
              spanElement.textContent = t.sidebar.importLayer;
            }
          }

          // Import from URL button
          const importFromUrlBtn = document.getElementById("importFromUrlBtn");
          if (importFromUrlBtn) {
            const spanElement = importFromUrlBtn.querySelector("span");
            if (spanElement) {
              spanElement.textContent = t.sidebar.importFromUrl;
            }
          }

          // Import from service button
          const importFromServiceBtn = document.getElementById(
            "importFromServiceBtn"
          );
          if (importFromServiceBtn) {
            const spanElement = importFromServiceBtn.querySelector("span");
            if (spanElement) {
              spanElement.textContent = t.sidebar.importFromService;
            }
          }

          // Supported formats text
          const supportedFormatsText = document.querySelector(
            ".import-formats small"
          );
          if (supportedFormatsText && t.sidebar.supportedFormats) {
            supportedFormatsText.textContent =
              t.sidebar.supportedFormats + ": GeoJSON, KML, Shapefile, CSV";
          }

          if (exportLayerBtn) {
            const iconElement = exportLayerBtn.querySelector("i");
            const spanElement = exportLayerBtn.querySelector("span");
            if (spanElement) {
              spanElement.textContent = t.sidebar.exportLayer;
            }
          }

          // Export layer select label
          const exportLayerSelectLabel = document.querySelector(
            'label[for="exportLayerSelect"]'
          );
          if (exportLayerSelectLabel) {
            exportLayerSelectLabel.textContent = t.sidebar.chooseLayerExport;
          }

          // Export layer select options
          const exportLayerSelect =
            document.getElementById("exportLayerSelect");
          if (exportLayerSelect) {
            const defaultOption =
              exportLayerSelect.querySelector('option[value=""]');
            if (defaultOption) {
              defaultOption.textContent = t.sidebar.selectLayer;
            }

            const neighborhoodsOption = exportLayerSelect.querySelector(
              'option[value="neighborhoods"]'
            );
            if (neighborhoodsOption) {
              neighborhoodsOption.textContent =
                t.sidebar.neighborhoodsBoundaries;
            }

            const neighborhoodLabelsOption = exportLayerSelect.querySelector(
              'option[value="neighborhood-labels"]'
            );
            if (neighborhoodLabelsOption) {
              neighborhoodLabelsOption.textContent =
                t.sidebar.neighborhoodsLabels;
            }

            const serviceSectorsOption = exportLayerSelect.querySelector(
              'option[value="service-sectors"]'
            );
            if (serviceSectorsOption) {
              serviceSectorsOption.textContent =
                t.sidebar.serviceSectorsBoundaries;
            }

            const serviceSectorLabelsOption = exportLayerSelect.querySelector(
              'option[value="service-sector-labels"]'
            );
            if (serviceSectorLabelsOption) {
              serviceSectorLabelsOption.textContent =
                t.sidebar.serviceSectorsLabels;
            }
          }

          if (exportFormatLabel)
            exportFormatLabel.textContent = t.sidebar.exportFormat;

          // symbols and colors title
          const symbolsColorsTitle = document.querySelector(
            ".sidebar-section:last-child h4"
          );
          if (symbolsColorsTitle)
            symbolsColorsTitle.textContent = t.sidebar.symbolsColors;

          // update layer style options
          const layerStyleSelect = document.getElementById("layerStyleSelect");
          if (layerStyleSelect) {
            const firstOption =
              layerStyleSelect.querySelector("option[value='']");
            if (firstOption) firstOption.textContent = t.sidebar.chooseLayer;

            const neighborhoodsOption = layerStyleSelect.querySelector(
              "option[value='neighborhoods']"
            );
            const serviceSectorsOption = layerStyleSelect.querySelector(
              "option[value='service-sectors']"
            );

            if (neighborhoodsOption)
              neighborhoodsOption.textContent = t.sidebar.neighborhoods;
            if (serviceSectorsOption)
              serviceSectorsOption.textContent = t.sidebar.serviceSectors;
          }

          // update style options
          const colorLabel = document.getElementById("colorLabel");
          const opacityLabel = document.getElementById("opacityLabel");
          const lineWeightLabel = document.getElementById("lineWeightLabel");
          const applyStyleBtn = document.getElementById("applyStyleBtn");
          const resetStyleBtn = document.getElementById("resetStyleBtn");

          if (colorLabel) colorLabel.textContent = t.sidebar.color;
          if (opacityLabel) opacityLabel.textContent = t.sidebar.transparency;
          if (lineWeightLabel)
            lineWeightLabel.textContent = t.sidebar.lineWeight;

          if (applyStyleBtn) {
            const iconElement = applyStyleBtn.querySelector("i");
            applyStyleBtn.innerHTML = "";
            if (iconElement) applyStyleBtn.appendChild(iconElement);
            applyStyleBtn.appendChild(
              document.createTextNode(" " + t.sidebar.apply)
            );
          }

          if (resetStyleBtn) {
            const iconElement = resetStyleBtn.querySelector("i");
            resetStyleBtn.innerHTML = "";
            if (iconElement) resetStyleBtn.appendChild(iconElement);
            resetStyleBtn.appendChild(
              document.createTextNode(" " + t.sidebar.reset)
            );
          }

          // Style section - Color by column
          const colorByColumnLabel = document.querySelector(
            "#neighborhoodColoringSection label"
          );
          if (colorByColumnLabel) {
            colorByColumnLabel.textContent = t.sidebar.colorByColumn;
          }

          const colorByColumnSelect = document.getElementById(
            "colorByColumnSelect"
          );
          if (colorByColumnSelect) {
            const defaultOption =
              colorByColumnSelect.querySelector('option[value=""]');
            if (defaultOption) {
              defaultOption.textContent = t.sidebar.selectColumn;
            }
          }

          const applyColumnColoringBtn = document.getElementById(
            "applyColumnColoringBtn"
          );
          if (applyColumnColoringBtn) {
            const iconElement = applyColumnColoringBtn.querySelector("i");
            applyColumnColoringBtn.innerHTML = "";
            if (iconElement) applyColumnColoringBtn.appendChild(iconElement);
            applyColumnColoringBtn.appendChild(
              document.createTextNode(" " + t.sidebar.applyColoring)
            );
          }

          const colorLegendTitle = document.querySelector("#colorLegend h5");
          if (colorLegendTitle) {
            colorLegendTitle.textContent = t.sidebar.colorLegend;
          }

          // update left sidebar auto-close indicator
          const leftAutoCloseMessage = document.getElementById(
            "left-auto-close-message"
          );
          if (
            leftAutoCloseMessage &&
            t.analysisQueries &&
            t.analysisQueries.autoCloseMessage
          ) {
            leftAutoCloseMessage.textContent =
              t.analysisQueries.autoCloseMessage;
          }

          // update left sidebar pin button title
          const pinLeftSidebar = document.getElementById("pinLeftSidebar");
          if (
            pinLeftSidebar &&
            t.analysisQueries &&
            t.analysisQueries.pinSidebar
          ) {
            pinLeftSidebar.title = t.analysisQueries.pinSidebar;
          }
        }

        // update urban effectiveness section
        if (t.urbanEffectiveness) {
          const ue = t.urbanEffectiveness;

          // main section title
          const urbanEffectivenessTitle = document.getElementById(
            "urban-effectiveness-title"
          );
          if (urbanEffectivenessTitle) {
            const iconElement = urbanEffectivenessTitle.querySelector("i");
            urbanEffectivenessTitle.innerHTML = "";
            if (iconElement) urbanEffectivenessTitle.appendChild(iconElement);
            urbanEffectivenessTitle.appendChild(
              document.createTextNode(" " + ue.title)
            );
          }

          // sectoral functions subsection
          const sectoralFunctionsTitle = document.getElementById(
            "sectoral-functions-title"
          );
          if (sectoralFunctionsTitle) {
            const iconElement = sectoralFunctionsTitle.querySelector("i");
            sectoralFunctionsTitle.innerHTML = "";
            if (iconElement) sectoralFunctionsTitle.appendChild(iconElement);
            sectoralFunctionsTitle.appendChild(
              document.createTextNode(" " + ue.sectoralFunctions.title)
            );
          }

          const sectoralFunctionsDescription = document.getElementById(
            "sectoral-functions-description"
          );
          if (sectoralFunctionsDescription) {
            sectoralFunctionsDescription.textContent =
              ue.sectoralFunctions.description;
          }

          const sectoralFunctionsButtonText = document.getElementById(
            "sectoral-functions-button-text"
          );
          if (sectoralFunctionsButtonText) {
            sectoralFunctionsButtonText.textContent =
              ue.sectoralFunctions.buttonText;
          }

          // abstract effectiveness subsection
          const abstractEffectivenessTitle = document.getElementById(
            "abstract-effectiveness-title"
          );
          if (abstractEffectivenessTitle) {
            const iconElement = abstractEffectivenessTitle.querySelector("i");
            abstractEffectivenessTitle.innerHTML = "";
            if (iconElement)
              abstractEffectivenessTitle.appendChild(iconElement);
            abstractEffectivenessTitle.appendChild(
              document.createTextNode(" " + ue.abstractEffectiveness.title)
            );
          }

          const abstractEffectivenessDescription = document.getElementById(
            "abstract-effectiveness-description"
          );
          if (abstractEffectivenessDescription) {
            abstractEffectivenessDescription.textContent =
              ue.abstractEffectiveness.description;
          }

          const abstractEffectivenessButtonText = document.getElementById(
            "abstract-effectiveness-button-text"
          );
          if (abstractEffectivenessButtonText) {
            abstractEffectivenessButtonText.textContent =
              ue.abstractEffectiveness.buttonText;
          }

          // final effectiveness subsection
          const finalEffectivenessTitle = document.getElementById(
            "final-effectiveness-title"
          );
          if (finalEffectivenessTitle) {
            const iconElement = finalEffectivenessTitle.querySelector("i");
            finalEffectivenessTitle.innerHTML = "";
            if (iconElement) finalEffectivenessTitle.appendChild(iconElement);
            finalEffectivenessTitle.appendChild(
              document.createTextNode(" " + ue.finalEffectiveness.title)
            );
          }

          const finalEffectivenessDescription = document.getElementById(
            "final-effectiveness-description"
          );
          if (finalEffectivenessDescription) {
            finalEffectivenessDescription.textContent =
              ue.finalEffectiveness.description;
          }

          const finalEffectivenessButtonText = document.getElementById(
            "final-effectiveness-button-text"
          );
          if (finalEffectivenessButtonText) {
            finalEffectivenessButtonText.textContent =
              ue.finalEffectiveness.buttonText;
          }
        }

        // update sidebar elements
        if (t.analysisQueries) {
          const aq = t.analysisQueries;

          // sidebar title with smooth transition
          const rightSidebarTitle = document.querySelector(
            "#rightSidebar .sidebar-header h3"
          );
          if (rightSidebarTitle) {
            // Add transition class
            rightSidebarTitle.classList.add("language-transition");

            setTimeout(() => {
              rightSidebarTitle.textContent = aq.title;
              rightSidebarTitle.classList.remove("language-transition");
            }, 150);
          }

          // query builder title
          const queryBuilderTitle = document.querySelector(
            "#rightSidebar .sidebar-section:nth-child(2) h4"
          );
          if (queryBuilderTitle)
            queryBuilderTitle.textContent = aq.queryBuilder;

          // query options
          const queryTableSelect = document.getElementById("queryTableSelect");
          const queryFieldSelect = document.getElementById("queryFieldSelect");
          const queryOperatorSelect = document.getElementById(
            "queryOperatorSelect"
          );
          const queryValueInput = document.getElementById("queryValueInput");

          if (queryTableSelect) {
            const firstOption =
              queryTableSelect.querySelector("option[value='']");
            if (firstOption) firstOption.textContent = aq.chooseLayer;
          }

          if (queryFieldSelect) {
            const firstOption =
              queryFieldSelect.querySelector("option[value='']");
            if (firstOption) firstOption.textContent = aq.chooseField;
          }

          if (queryOperatorSelect) {
            const firstOption =
              queryOperatorSelect.querySelector("option[value='']");
            if (firstOption) firstOption.textContent = aq.chooseOperation;
          }

          if (queryValueInput) queryValueInput.placeholder = aq.enterValue;

          // update query table select options
          const queryNeighborhoodsOption = document.getElementById(
            "query-neighborhoods-option"
          );
          const queryServiceSectorsOption = document.getElementById(
            "query-service-sectors-option"
          );
          const queryContainsOption = document.getElementById(
            "query-contains-option"
          );

          if (queryNeighborhoodsOption)
            queryNeighborhoodsOption.textContent = aq.neighborhoods;
          if (queryServiceSectorsOption)
            queryServiceSectorsOption.textContent = aq.serviceSectors;
          if (queryContainsOption)
            queryContainsOption.textContent = aq.contains;

          // update auto-close indicator
          const autoCloseMessage =
            document.getElementById("auto-close-message");
          if (autoCloseMessage)
            autoCloseMessage.textContent = aq.autoCloseMessage;

          // update left sidebar auto-close indicator
          const leftAutoCloseMessage = document.getElementById(
            "left-auto-close-message"
          );
          if (leftAutoCloseMessage)
            leftAutoCloseMessage.textContent = aq.autoCloseMessage;

          // update pin button title
          const pinRightSidebar = document.getElementById("pinRightSidebar");
          if (pinRightSidebar && aq.pinSidebar)
            pinRightSidebar.title = aq.pinSidebar;

          // update left sidebar pin button
          const pinLeftSidebar = document.getElementById("pinLeftSidebar");
          if (pinLeftSidebar && aq.pinSidebar)
            pinLeftSidebar.title = aq.pinSidebar;

          // query buttons
          const addConditionBtn = document.getElementById("addConditionBtn");
          const runQueryBtn = document.getElementById("runQueryBtn");

          if (addConditionBtn) {
            const iconElement = addConditionBtn.querySelector("i");
            addConditionBtn.innerHTML = "";
            if (iconElement) addConditionBtn.appendChild(iconElement);
            addConditionBtn.appendChild(
              document.createTextNode(" " + aq.addCondition)
            );
          }

          if (runQueryBtn) {
            const iconElement = runQueryBtn.querySelector("i");
            runQueryBtn.innerHTML = "";
            if (iconElement) runQueryBtn.appendChild(iconElement);
            runQueryBtn.appendChild(document.createTextNode(" " + aq.runQuery));
          }

          // empty query results message
          const emptyState = document.querySelector(
            ".query-results .empty-state"
          );
          if (emptyState) emptyState.textContent = aq.createQueryMessage;

          // neighborhood report section
          if (t.neighborhoodReport) {
            const nr = t.neighborhoodReport;

            // neighborhood report title
            const neighborhoodReportTitle = document.querySelector(
              "#rightSidebar .sidebar-section:nth-child(4) h4"
            );
            if (neighborhoodReportTitle) {
              const iconElement = neighborhoodReportTitle.querySelector("i");
              neighborhoodReportTitle.innerHTML = "";
              if (iconElement) neighborhoodReportTitle.appendChild(iconElement);
              neighborhoodReportTitle.appendChild(
                document.createTextNode(" " + nr.title)
              );
            }

            // neighborhood select label
            const neighborhoodSelectLabel = document.querySelector(
              'label[for="reportNeighborhoodSelect"]'
            );
            if (neighborhoodSelectLabel) {
              const iconElement = neighborhoodSelectLabel.querySelector("i");
              neighborhoodSelectLabel.innerHTML = "";
              if (iconElement) neighborhoodSelectLabel.appendChild(iconElement);
              neighborhoodSelectLabel.appendChild(
                document.createTextNode(" " + nr.chooseNeighborhood)
              );
            }

            // neighborhood select default option
            const neighborhoodSelectDefault = document.querySelector(
              '#reportNeighborhoodSelect option[value=""]'
            );
            if (neighborhoodSelectDefault) {
              neighborhoodSelectDefault.textContent = nr.selectNeighborhood;
            }

            // export button
            const exportReportBtn = document.getElementById("exportReportBtn");
            if (exportReportBtn) {
              const iconElement = exportReportBtn.querySelector("i");
              exportReportBtn.innerHTML = "";
              if (iconElement) exportReportBtn.appendChild(iconElement);
              exportReportBtn.appendChild(
                document.createTextNode(" " + nr.exportButton)
              );
            }

            // checkbox labels
            const checkboxLabels = [
              { id: "includeMapImage", text: nr.includeMap },
              { id: "includeNeighborhoodInfo", text: nr.includeInfo },
              { id: "includeSectoralFunctions", text: nr.includeSectoral },
              { id: "includeDamageRatios", text: nr.includeDamage },
            ];

            checkboxLabels.forEach((item) => {
              const checkbox = document.getElementById(item.id);
              if (checkbox) {
                const label = checkbox.parentElement;
                if (label && label.tagName === "LABEL") {
                  const span = label.querySelector("span");
                  if (span) {
                    span.textContent = item.text;
                  }
                }
              }
            });
          }

          // filter title
          const filterTitle = document.querySelector(
            "#rightSidebar .sidebar-section:nth-child(3) h4"
          );
          if (filterTitle) {
            const iconElement = filterTitle.querySelector("i");
            filterTitle.innerHTML = "";
            if (iconElement) filterTitle.appendChild(iconElement);
            filterTitle.appendChild(
              document.createTextNode(" " + aq.filterBySection)
            );
          }

          // filter options
          const sectorFilterSelect =
            document.getElementById("sectorFilterSelect");
          const applySectorFilterBtn = document.getElementById(
            "applySectorFilterBtn"
          );
          const exportFilteredBtn =
            document.getElementById("exportFilteredBtn");

          if (sectorFilterSelect) {
            const firstOption =
              sectorFilterSelect.querySelector("option[value='']");
            if (firstOption) firstOption.textContent = aq.allSectors;
          }

          if (applySectorFilterBtn) {
            const iconElement = applySectorFilterBtn.querySelector("i");
            applySectorFilterBtn.innerHTML = "";
            if (iconElement) applySectorFilterBtn.appendChild(iconElement);
            applySectorFilterBtn.appendChild(
              document.createTextNode(" " + aq.apply)
            );
          }

          if (exportFilteredBtn) {
            const iconElement = exportFilteredBtn.querySelector("i");
            exportFilteredBtn.innerHTML = "";
            if (iconElement) exportFilteredBtn.appendChild(iconElement);
            exportFilteredBtn.appendChild(
              document.createTextNode(" " + aq.exportFilteredResults)
            );
          }

          // chart analysis title
          const chartAnalysisTitle = document.querySelector(
            "#rightSidebar .sidebar-section:nth-child(4) h4"
          );
          if (chartAnalysisTitle)
            chartAnalysisTitle.textContent = aq.chartAnalysis;

          // chart options
          const chartType = document.getElementById("chartType");
          const chartData = document.getElementById("chartData");
          const generateChartBtn = document.getElementById("generateChartBtn");

          if (chartType) {
            const options = chartType.querySelectorAll("option");
            if (options.length > 0) {
              options[0].textContent = aq.chooseChartType;
              if (options.length > 1) options[1].textContent = aq.barChart;
              if (options.length > 2) options[2].textContent = aq.pieChart;
              if (options.length > 3) options[3].textContent = aq.lineChart;
              if (options.length > 4) options[4].textContent = aq.radarChart;
            }
          }

          if (chartData) {
            const options = chartData.querySelectorAll("option");
            if (options.length > 0) {
              options[0].textContent = aq.chooseData;
              if (options.length > 1) options[1].textContent = aq.area;
              if (options.length > 2) options[2].textContent = aq.sector;
              if (options.length > 3) options[3].textContent = aq.population;
              if (options.length > 4) options[4].textContent = aq.damage;
            }
          }

          if (generateChartBtn) {
            const iconElement = generateChartBtn.querySelector("i");
            generateChartBtn.innerHTML = "";
            if (iconElement) generateChartBtn.appendChild(iconElement);
            generateChartBtn.appendChild(
              document.createTextNode(" " + aq.generateChart)
            );
          }

          // advanced analysis title
          const advancedAnalysisTitle = document.querySelector(
            "#rightSidebar .sidebar-section:nth-child(5) h4"
          );
          if (advancedAnalysisTitle)
            advancedAnalysisTitle.textContent = aq.advancedAnalysis;

          // advanced analysis buttons
          const densityAnalysisBtn =
            document.getElementById("densityAnalysisBtn");
          const infrastructureAnalysisBtn = document.getElementById(
            "infrastructureAnalysisBtn"
          );
          const serviceAccessAnalysisBtn = document.getElementById(
            "serviceAccessAnalysisBtn"
          );
          const damageAnalysisBtn =
            document.getElementById("damageAnalysisBtn");

          if (densityAnalysisBtn) {
            const iconElement = densityAnalysisBtn.querySelector("i");
            densityAnalysisBtn.innerHTML = "";
            if (iconElement) densityAnalysisBtn.appendChild(iconElement);
            densityAnalysisBtn.appendChild(
              document.createTextNode(" " + aq.populationDensity)
            );
          }

          if (infrastructureAnalysisBtn) {
            const iconElement = infrastructureAnalysisBtn.querySelector("i");
            infrastructureAnalysisBtn.innerHTML = "";
            if (iconElement) infrastructureAnalysisBtn.appendChild(iconElement);
            infrastructureAnalysisBtn.appendChild(
              document.createTextNode(" " + aq.infrastructure)
            );
          }

          if (serviceAccessAnalysisBtn) {
            const iconElement = serviceAccessAnalysisBtn.querySelector("i");
            serviceAccessAnalysisBtn.innerHTML = "";
            if (iconElement) serviceAccessAnalysisBtn.appendChild(iconElement);
            serviceAccessAnalysisBtn.appendChild(
              document.createTextNode(" " + aq.serviceAccess)
            );
          }

          if (damageAnalysisBtn) {
            const iconElement = damageAnalysisBtn.querySelector("i");
            damageAnalysisBtn.innerHTML = "";
            if (iconElement) damageAnalysisBtn.appendChild(iconElement);
            damageAnalysisBtn.appendChild(
              document.createTextNode(" " + aq.damageAnalysis)
            );
          }
        }

        // update info panel
        const infoPanel = document.getElementById("info-panel");
        if (infoPanel) {
          // Update buttons text
          const cancelChangesBtn = document.getElementById("cancel-changes");
          const saveChangesBtn = document.getElementById("save-changes");

          if (cancelChangesBtn && t.cancelChanges) {
            cancelChangesBtn.textContent = t.cancelChanges;
          }

          if (saveChangesBtn && t.saveChanges) {
            saveChangesBtn.textContent = t.saveChanges;
          }

          // Refresh panel content if it's open
          if (infoPanel.classList.contains("show")) {
            const activeTab = document.querySelector(".tab-button.active");
            if (activeTab) {
              const tabId = activeTab.getAttribute("data-tab");
              if (tabId && selectedNeighborhoodId) {
                renderInfoPanel(tabId, selectedNeighborhoodId);
              }
            }
          }
        }

        // Update Buffer Analysis section if available
        if (
          window.BufferAnalysis &&
          typeof window.BufferAnalysis.updateLanguage === "function"
        ) {
          window.BufferAnalysis.updateLanguage();
        }

        // Update map info bar when language changes
        if (
          typeof updateMapInfoBar === "function" &&
          window.map &&
          typeof window.map.getCenter === "function"
        ) {
          updateMapInfoBar();
        }
      }

      // Helper function to check if an element is inside a no-translate container
      function isInNoTranslateContainer(element) {
        let parent = element.parentElement;
        while (parent) {
          if (parent.classList && parent.classList.contains("no-translate")) {
            return true;
          }
          parent = parent.parentElement;
        }
        return false;
      }

      function toggleMenu() {
        const menu = document.getElementById("menuDropdown");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      }

      document.addEventListener("click", function (event) {
        const dropdown = document.querySelector(".menu-dropdown");
        if (dropdown && !dropdown.contains(event.target)) {
          document.getElementById("menuDropdown").style.display = "none";
        }
      });

      function logout() {
        // redirect user to the home page
        window.location.href = "../index.html";
      }

      // initialize default language
      document.addEventListener("DOMContentLoaded", function () {
        // remove saved language first to ensure default
        localStorage.removeItem("selectedLanguage");
        // set default language
        localStorage.setItem("selectedLanguage", "ar");

        // Apply fixed styles to header and footer to prevent layout shifts
        document.querySelectorAll(".no-translate").forEach((element) => {
          element.style.direction = "rtl";

          // Make sure both titles are visible in the header
          if (element.id === "mainHeader") {
            const titleAr = element.querySelector(".title-ar");
            const titleEn = element.querySelector(".title-en");

            if (titleAr) titleAr.style.display = "block";
            if (titleEn) titleEn.style.display = "block";
          }
        });

        // apply arabic language
        switchLanguage("ar");

        // update language toggle button text
        const langToggleBtn = document.getElementById("langToggleBtn");
        if (langToggleBtn) {
          langToggleBtn.textContent = "AR";
        }

        // set page direction to RTL
        document.documentElement.dir = "rtl";
        document.documentElement.lang = "ar";
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Service Sectors Layer Checkbox
        const serviceSectorsCheckbox = document.getElementById(
          "layer-service-sectors"
        );
        if (serviceSectorsCheckbox) {
          serviceSectorsCheckbox.addEventListener("change", function () {
            if (window.mapLayerToggle) {
              window.mapLayerToggle("service-sectors", this.checked);
            }
          });
        }

        // Neighborhoods Layer Checkbox (optional, for consistency)
        const neighborhoodsCheckbox = document.getElementById(
          "layer-neighborhoods"
        );
        if (neighborhoodsCheckbox) {
          neighborhoodsCheckbox.addEventListener("change", function () {
            if (window.mapLayerToggle) {
              window.mapLayerToggle("neighborhoods", this.checked);
            }
          });
        }

        // Aleppo City Layer Checkbox
        const aleppoCityCheckbox = document.getElementById("layer-aleppo-city");
        if (aleppoCityCheckbox) {
          aleppoCityCheckbox.addEventListener("change", function () {
            if (window.mapLayerToggle) {
              window.mapLayerToggle("aleppo-city", this.checked);
            }
          });
        }
      });

      function toggleLayersPanel() {
        var modal = document.getElementById("customLayersModal");
        if (modal.classList.contains("open")) {
          modal.classList.remove("open");
        } else {
          modal.classList.add("open");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Service Sectors Layer Checkbox
        const serviceSectorsCheckbox = document.getElementById(
          "layer-service-sectors"
        );
        if (serviceSectorsCheckbox) {
          serviceSectorsCheckbox.addEventListener("change", function () {
            if (window.mapLayerToggle) {
              window.mapLayerToggle("service-sectors", this.checked);
            }
          });
        }

        // Neighborhoods Layer Checkbox (optional, for consistency)
        const neighborhoodsCheckbox = document.getElementById(
          "layer-neighborhoods"
        );
        if (neighborhoodsCheckbox) {
          neighborhoodsCheckbox.addEventListener("change", function () {
            if (window.mapLayerToggle) {
              window.mapLayerToggle("neighborhoods", this.checked);
            }
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var tabs = document.querySelector(".tabs-container");
        if (tabs) {
          tabs.classList.remove("collapsed");
          // initial hidden state with motion effects
          tabs.classList.add("hidden");
          tabs.style.display = "none";
          tabs.style.zIndex = "3000";
        }

        // Add event listener for the tabs toggle button (now in the toolbar)
        const tabsToggleBtn = document.getElementById("tabsToggleBtn");
        if (tabsToggleBtn) {
          // Remove any old classes and add toolbar button styling
          tabsToggleBtn.className = "";

          tabsToggleBtn.addEventListener("click", function () {
            if (tabs) {
              if (
                tabs.classList.contains("hidden") ||
                tabs.style.display === "none"
              ) {
                // show tabs with motion effects
                tabs.style.display = "flex";
                // wait for the transition to apply
                setTimeout(function () {
                  tabs.classList.remove("hidden");
                  tabs.classList.add("visible");
                }, 10);
              } else {
                // hide tabs with motion effects
                tabs.classList.remove("visible");
                tabs.classList.add("hidden");
                // wait for the transition to apply
                setTimeout(function () {
                  tabs.style.display = "none";
                }, 400); // same transition time
              }
            }
          });
        }

        // Make sure map compass and basemap gallery are visible
        const mapCompass = document.querySelector(".map-compass");
        if (mapCompass) {
          mapCompass.style.display = "flex";
          mapCompass.style.visibility = "visible";
        }

        // Ensure basemap gallery works with layers button
        const layersBtn = document.getElementById("layers-btn");
        const basemapGallery = document.getElementById("basemap-gallery");

        if (layersBtn && basemapGallery) {
          layersBtn.addEventListener("click", function () {
            basemapGallery.classList.toggle("open");
          });

          // Close gallery when clicking outside
          document.addEventListener("click", function (e) {
            if (!basemapGallery.contains(e.target) && e.target !== layersBtn) {
              basemapGallery.classList.remove("open");
            }
          });
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Clear any existing event listeners by cloning and replacing the button
        const layersBtn = document.getElementById("layers-btn");
        const basemapGallery = document.getElementById("basemap-gallery");

        if (layersBtn && basemapGallery) {
          const newLayersBtn = layersBtn.cloneNode(true);
          layersBtn.parentNode.replaceChild(newLayersBtn, layersBtn);

          // Add event listener to the new button
          newLayersBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            console.log("Layers button clicked");
            basemapGallery.classList.toggle("open");
          });

          // Close when clicking outside
          document.addEventListener("click", function (e) {
            if (
              !basemapGallery.contains(e.target) &&
              e.target !== newLayersBtn
            ) {
              basemapGallery.classList.remove("open");
            }
          });

          // Handle basemap selection
          const basemapThumbs = document.querySelectorAll(".basemap-thumb");
          basemapThumbs.forEach((thumb) => {
            thumb.addEventListener("click", function () {
              const basemapType = this.getAttribute("data-basemap");

              // Remove selected class from all thumbnails
              basemapThumbs.forEach((t) => t.classList.remove("selected"));

              // Add selected class to clicked thumbnail
              this.classList.add("selected");

              // Change basemap layer (this would connect to your map.js implementation)
              if (window.changeBasemap) {
                window.changeBasemap(basemapType);
              } else {
                console.log("Changing basemap to:", basemapType);
              }

              // Close the gallery
              basemapGallery.classList.remove("open");
            });
          });
        }

        // Create placeholder images if they don't exist
        if (
          document.querySelectorAll(
            '.basemap-thumb img[src="assets/img/basemap-osm.jpg"]'
          ).length > 0
        ) {
          // Create a function to generate base64 placeholder images
          function createPlaceholderImage(color) {
            const canvas = document.createElement("canvas");
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 80, 80);
            return canvas.toDataURL();
          }

          // Replace missing images with placeholders
          document.querySelectorAll(".basemap-thumb img").forEach((img) => {
            img.onerror = function () {
              let color = "#e3e3e3";
              if (img.alt === "Satellite") color = "#2d2d2d";
              if (img.alt === "Terrain") color = "#c5e8c5";
              if (img.alt === "Dark") color = "#121212";

              this.src = createPlaceholderImage(color);
            };
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Handle new basemap button
        const basemapButton = document.getElementById("basemap-button");
        const basemapGallery = document.getElementById("basemap-gallery");

        if (basemapButton && basemapGallery) {
          basemapButton.addEventListener("click", function (e) {
            e.stopPropagation();
            console.log("Basemap button clicked");
            basemapGallery.classList.toggle("open");
          });
        }

        // Clear any existing event listeners by cloning and replacing the button
        const layersBtn = document.getElementById("layers-btn");

        if (layersBtn && basemapGallery) {
          const newLayersBtn = layersBtn.cloneNode(true);
          layersBtn.parentNode.replaceChild(newLayersBtn, layersBtn);

          // Add event listener to the new button
          newLayersBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            console.log("Layers button clicked");
            basemapGallery.classList.toggle("open");
          });

          // Close when clicking outside
          document.addEventListener("click", function (e) {
            if (
              !basemapGallery.contains(e.target) &&
              e.target !== newLayersBtn &&
              e.target !== basemapButton
            ) {
              basemapGallery.classList.remove("open");
            }
          });

          // Handle basemap selection
          const basemapThumbs = document.querySelectorAll(".basemap-thumb");
          basemapThumbs.forEach((thumb) => {
            thumb.addEventListener("click", function () {
              const basemapType = this.getAttribute("data-basemap");

              // Remove selected class from all thumbnails
              basemapThumbs.forEach((t) => t.classList.remove("selected"));

              // Add selected class to clicked thumbnail
              this.classList.add("selected");

              // Change basemap layer (this would connect to your map.js implementation)
              if (window.changeBasemap) {
                window.changeBasemap(basemapType);
              } else {
                console.log("Changing basemap to:", basemapType);

                // Basic implementation if window.changeBasemap doesn't exist
                if (window.map) {
                  // Remove any existing tile layers
                  window.map.eachLayer(function (layer) {
                    if (layer._url && layer._url.includes("tile")) {
                      window.map.removeLayer(layer);
                    }
                  });

                  // Add the selected basemap
                  if (basemapType === "osm") {
                    L.tileLayer(
                      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                      {
                        maxZoom: 19,
                      }
                    ).addTo(window.map);
                  } else if (basemapType === "satellite") {
                    L.tileLayer(
                      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                      {
                        maxZoom: 19,
                      }
                    ).addTo(window.map);
                  } else if (basemapType === "terrain") {
                    L.tileLayer(
                      "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
                      {
                        maxZoom: 17,
                        attribution:
                          '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
                      }
                    ).addTo(window.map);
                  } else if (basemapType === "dark") {
                    L.tileLayer(
                      "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png",
                      {
                        maxZoom: 19,
                      }
                    ).addTo(window.map);
                  }
                }
              }

              // Close the gallery
              basemapGallery.classList.remove("open");
            });
          });
        }

        // Create placeholder images if they don't exist
        document.querySelectorAll(".basemap-thumb img").forEach((img) => {
          img.onerror = function () {
            let color = "#e3e3e3";
            if (img.alt === "Satellite") color = "#2d2d2d";
            if (img.alt === "Terrain") color = "#c5e8c5";
            if (img.alt === "Dark") color = "#121212";

            // Create a canvas element
            const canvas = document.createElement("canvas");
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext("2d");

            // Fill with background color
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 80, 80);

            // Add label text
            ctx.fillStyle = color === "#121212" ? "#ffffff" : "#333333";
            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.fillText(img.alt, 40, 40);

            // Replace the image source with the canvas data URL
            this.src = canvas.toDataURL();
          };
        });

        // Ensure the basemap button is visible
        if (basemapButton) {
          basemapButton.style.display = "flex";
        }
      });
    </script>
    <!-- Simple Basemap Button and Gallery -->
    <div
      id="simple-basemap-button"
      style="
        position: fixed;
        left: 20px;
        bottom: 60px;
        width: 50px;
        height: 50px;
        background-color: #2196f3;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        font-size: 24px;
      "
    >
      <i class="fas fa-map"></i>
    </div>

    <div
      id="simple-basemap-gallery"
      style="
        display: none;
        position: fixed;
        left: 50px;
        bottom: 120px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        z-index: 999;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
        width: 250px;
      "
    >
      <div style="font-weight: bold; margin-bottom: 10px; text-align: center">
        اختر الخريطة الأساسية
      </div>
      <div
        style="
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        "
      >
        <div
          class="simple-basemap-option"
          data-type="osm"
          style="
            width: 100px;
            height: 80px;
            background-color: #e8e8e8;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #ddd;
            flex-direction: column;
          "
        >
          <div style="font-size: 24px; color: #666">
            <i class="fas fa-map"></i>
          </div>
          <div style="font-size: 12px; margin-top: 5px">خريطة الشارع</div>
        </div>

        <div
          class="simple-basemap-option"
          data-type="satellite"
          style="
            width: 100px;
            height: 80px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #ddd;
            flex-direction: column;
          "
        >
          <div style="font-size: 24px"><i class="fas fa-satellite"></i></div>
          <div style="font-size: 12px; margin-top: 5px">أقمار صناعية</div>
        </div>

        <div
          class="simple-basemap-option"
          data-type="terrain"
          style="
            width: 100px;
            height: 80px;
            background-color: #c5d6c0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #ddd;
            flex-direction: column;
          "
        >
          <div style="font-size: 24px; color: #4a6741">
            <i class="fas fa-mountain"></i>
          </div>
          <div style="font-size: 12px; margin-top: 5px">تضاريس</div>
        </div>

        <div
          class="simple-basemap-option"
          data-type="dark"
          style="
            width: 100px;
            height: 80px;
            background-color: #121212;
            color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid #ddd;
            flex-direction: column;
          "
        >
          <div style="font-size: 24px"><i class="fas fa-moon"></i></div>
          <div style="font-size: 12px; margin-top: 5px">داكن</div>
        </div>
      </div>
    </div>

    <script>
      // Simple direct JavaScript to handle basemap gallery
      document.addEventListener("DOMContentLoaded", function () {
        var simpleButton = document.getElementById("simple-basemap-button");
        var simpleGallery = document.getElementById("simple-basemap-gallery");
        var isGalleryOpen = false;

        // Button click to toggle gallery
        if (simpleButton && simpleGallery) {
          simpleButton.onclick = function (e) {
            e.stopPropagation();
            if (isGalleryOpen) {
              simpleGallery.style.display = "none";
              isGalleryOpen = false;
            } else {
              simpleGallery.style.display = "block";
              isGalleryOpen = true;
            }
          };

          // Close gallery when clicking outside
          document.addEventListener("click", function (event) {
            if (
              isGalleryOpen &&
              event.target !== simpleButton &&
              !simpleGallery.contains(event.target)
            ) {
              simpleGallery.style.display = "none";
              isGalleryOpen = false;
            }
          });

          // Handle basemap selection
          var options = document.querySelectorAll(".simple-basemap-option");
          options.forEach(function (option) {
            option.onclick = function () {
              // Reset all borders
              options.forEach(function (opt) {
                opt.style.border = "3px solid #ddd";
              });

              // Highlight selected
              this.style.border = "3px solid #2196F3";

              // Get basemap type
              var type = this.getAttribute("data-type");
              console.log("Selected basemap: " + type);

              // Change the basemap
              if (window.map) {
                // Remove any existing tile layers
                window.map.eachLayer(function (layer) {
                  if (layer._url && layer._url.includes("tile")) {
                    window.map.removeLayer(layer);
                  }
                });

                // Add the selected basemap
                if (type === "osm") {
                  L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                      maxZoom: 19,
                    }
                  ).addTo(window.map);
                } else if (type === "satellite") {
                  L.tileLayer(
                    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                    {
                      maxZoom: 19,
                    }
                  ).addTo(window.map);
                } else if (type === "terrain") {
                  L.tileLayer(
                    "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
                    {
                      maxZoom: 17,
                      attribution:
                        '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
                    }
                  ).addTo(window.map);
                } else if (type === "dark") {
                  L.tileLayer(
                    "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png",
                    {
                      maxZoom: 19,
                    }
                  ).addTo(window.map);
                }
              }

              // Close the gallery
              setTimeout(function () {
                simpleGallery.style.display = "none";
                isGalleryOpen = false;
              }, 300);
            };
          });
        }
      });
    </script>

    <!-- Fix for map.js null element error -->
    <script>
      // This script runs before other scripts to patch the addEventListener method
      document.addEventListener("DOMContentLoaded", function () {
        // Create a safety wrapper for addEventListener
        const originalAddEventListener = Element.prototype.addEventListener;

        // Override with a version that checks for null
        Element.prototype.addEventListener = function () {
          if (this) {
            return originalAddEventListener.apply(this, arguments);
          }
        };

        // Create any elements that might be expected by map.js but don't exist
        if (!document.getElementById("layer-neighborhoods")) {
          const dummyElement = document.createElement("input");
          dummyElement.type = "checkbox";
          dummyElement.id = "layer-neighborhoods";
          dummyElement.style.display = "none";
          dummyElement.checked = true;
          document.body.appendChild(dummyElement);
        }

        if (!document.getElementById("layer-service-sectors")) {
          const dummyElement = document.createElement("input");
          dummyElement.type = "checkbox";
          dummyElement.id = "layer-service-sectors";
          dummyElement.style.display = "none";
          dummyElement.checked = true;
          document.body.appendChild(dummyElement);
        }
      });
    </script>
    <script>
      // عند إظهار info-panel، أظهر tabs تلقائياً
      (function () {
        var tryPatch = function () {
          if (
            window.renderInfoPanel &&
            !window.renderInfoPanel._tabsAutoShowPatched
          ) {
            var origRenderInfoPanel = window.renderInfoPanel;
            window.renderInfoPanel = function (tabId, neighborhoodId) {
              // أظهر التبويبات إذا كانت مخفية
              var tabs = document.querySelector(".tabs-container");
              if (
                tabs &&
                (tabs.classList.contains("hidden") ||
                  tabs.style.display === "none")
              ) {
                tabs.style.display = "flex";
                setTimeout(function () {
                  tabs.classList.remove("hidden");
                  tabs.classList.add("visible");
                }, 10);
              }
              // نفذ الدالة الأصلية
              return origRenderInfoPanel.apply(this, arguments);
            };
            window.renderInfoPanel._tabsAutoShowPatched = true;
          }
        };
        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          setTimeout(tryPatch, 0);
        } else {
          document.addEventListener("DOMContentLoaded", tryPatch);
        }
      })();
    </script>
    <script>
      function getDamageRatiosForNeighborhood(neighborhoodId) {
        console.log(
          "Getting damage ratios for neighborhood ID:",
          neighborhoodId
        );

        // Try to get damage data from housingData in aleppo-data.js
        if (typeof housingData !== "undefined") {
          const damageInfo = housingData.find(
            (h) => h.neighborhoodId == neighborhoodId
          );
          if (damageInfo) {
            console.log("Found damage data in housingData:", damageInfo);
            return {
              severeDamagePercentage: damageInfo.severeDamagePercentage,
              mediumDamagePercentage: damageInfo.mediumDamagePercentage,
              lightDamagePercentage: damageInfo.lightDamagePercentage,
              noDamagePercentage: damageInfo.noDamagePercentage,
              totalUnits: damageInfo.totalUnits,
              vacantPercentage: damageInfo.vacantPercentage,
              ownershipType: damageInfo.ownershipType,
              interventionPriority: damageInfo.interventionPriority,
            };
          }
        }

        // Try to get damage data from neighborhood properties
        let neighborhoodFeature = null;
        if (
          typeof neighborhoodsData !== "undefined" &&
          neighborhoodsData.features
        ) {
          neighborhoodFeature = neighborhoodsData.features.find(
            (f) => f.properties.ID == neighborhoodId
          );
        } else if (typeof aleppoNeighborhoods !== "undefined") {
          neighborhoodFeature = aleppoNeighborhoods.find(
            (n) => n.id == neighborhoodId
          );
        }

        if (neighborhoodFeature && neighborhoodFeature.properties) {
          const props = neighborhoodFeature.properties;
          // Check if damage data exists in neighborhood properties
          if (props.severeDamagePercentage || props.damage_level) {
            return {
              severeDamagePercentage:
                props.severeDamagePercentage ||
                (props.damage_level > 75 ? 80 : 0),
              mediumDamagePercentage:
                props.mediumDamagePercentage ||
                (props.damage_level > 50 ? 60 : 0),
              lightDamagePercentage:
                props.lightDamagePercentage ||
                (props.damage_level > 25 ? 40 : 0),
              noDamagePercentage:
                props.noDamagePercentage || 100 - (props.damage_level || 0),
            };
          }
        }

        // Generate sample damage data based on neighborhood ID for demonstration
        console.log(
          "No damage data found, generating sample data for neighborhood:",
          neighborhoodId
        );
        const seed = parseInt(neighborhoodId) || 1;
        const severe = Math.max(0, Math.min(50, (seed * 7) % 51));
        const medium = Math.max(0, Math.min(40, (seed * 11) % 41));
        const light = Math.max(0, Math.min(30, (seed * 13) % 31));
        const noDamage = Math.max(0, 100 - severe - medium - light);

        return {
          severeDamagePercentage: severe,
          mediumDamagePercentage: medium,
          lightDamagePercentage: light,
          noDamagePercentage: noDamage,
          note: "بيانات تقديرية للعرض",
        };
      }

      function showSuccessNotification(message) {
        const notification = document.createElement("div");
        notification.style.position = "fixed";
        notification.style.top = "20px";
        notification.style.right = "20px";
        notification.style.backgroundColor = "#4CAF50";
        notification.style.color = "white";
        notification.style.padding = "15px";
        notification.style.borderRadius = "5px";
        notification.style.zIndex = "10000";
        notification.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.transition = "opacity 0.5s";
          notification.style.opacity = "0";
          setTimeout(() => document.body.removeChild(notification), 500);
        }, 3000);
      }

      // Helper function to generate sample sectoral data
      function generateSampleSectoralData(neighborhoodId) {
        const sectoralFunctions = [
          "التدخلات الإنسانية",
          "الأسواق الأساسية",
          "إدارة النفايات الصلبة",
          "شبكة الكهرباء",
          "شبكة الاتصالات",
          "إمدادات المياه",
          "شبكة الصرف الصحي",
          "أضرار الإسكان",
          "النسيج الحضري",
          "التغيرات السكانية",
        ];

        const sampleData = {};

        // Generate realistic sample data based on neighborhood ID
        const seed = parseInt(neighborhoodId) || 1;
        for (let i = 0; i < sectoralFunctions.length; i++) {
          // Generate values between 20-95% with some variation based on seed and index
          const baseValue = 40 + ((seed * 7 + i * 13) % 50);
          const variation = ((seed + i) % 20) - 10; // ±10% variation
          const finalValue = Math.max(20, Math.min(95, baseValue + variation));
          sampleData[sectoralFunctions[i]] = finalValue;
        }

        return sampleData;
      }

      // الألوان الافتراضية للطبقات
      const defaultStyles = {
        neighborhoods: {
          color: "#1e40af",
          fillColor: "#3b82f6",
          fillOpacity: 0.6,
          opacity: 0.8,
          weight: 2,
        },
        serviceSectors: {
          color: "#dc2626",
          fillColor: "#ef4444",
          fillOpacity: 0.5,
          opacity: 0.7,
          weight: 2,
        },
      };

      // دالة إعادة ضبط جميع الطبقات إلى الأنماط الافتراضية
      function resetAllLayersToDefault() {
        try {
          console.log("إعادة ضبط جميع الطبقات إلى الأنماط الافتراضية...");

          // إعادة ضبط طبقة الأحياء
          resetLayerToDefault("neighborhoods");

          // إعادة ضبط طبقة دوائر الخدمات
          resetLayerToDefault("serviceSectors");

          console.log("تم إعادة ضبط جميع الطبقات بنجاح");
        } catch (error) {
          console.error("خطأ في إعادة ضبط الطبقات:", error);
        }
      }

      // دالة إعادة ضبط طبقة واحدة إلى النمط الافتراضي
      function resetLayerToDefault(layerType) {
        try {
          let layersReset = 0;
          const defaultStyle = defaultStyles[layerType];

          if (!defaultStyle) {
            console.warn(`لا توجد أنماط افتراضية للطبقة: ${layerType}`);
            return;
          }

          // البحث في جميع طبقات الخريطة
          if (window.map && window.map.eachLayer) {
            window.map.eachLayer(function (layer) {
              let shouldReset = false;

              // تحديد ما إذا كانت هذه هي الطبقة المطلوب إعادة ضبطها
              if (
                layerType === "neighborhoods" &&
                layer.feature &&
                layer.feature.properties &&
                (layer.feature.properties.NAME ||
                  layer.feature.properties.name ||
                  layer.feature.properties.Name ||
                  layer.feature.properties.ID)
              ) {
                shouldReset = true;
              } else if (
                layerType === "serviceSectors" &&
                layer.feature &&
                layer.feature.properties &&
                (layer.feature.properties.Name ||
                  layer.feature.properties.OBJECTID)
              ) {
                shouldReset = true;
              }

              if (shouldReset) {
                layer.setStyle(defaultStyle);
                layersReset++;
              }
            });
          }

          // محاولة إعادة الضبط عبر متغيرات عامة
          const possibleVariables =
            layerType === "neighborhoods"
              ? [
                  "neighborhoodsLayer",
                  "neighborhoods",
                  "neighborhoodsData",
                  "window.neighborhoodsLayer",
                ]
              : [
                  "serviceSectorsLayer",
                  "serviceSectors",
                  "serviceSectorsData",
                  "window.serviceSectorsLayer",
                ];

          possibleVariables.forEach((varName) => {
            try {
              let layer = eval(varName);
              if (layer && typeof layer.setStyle === "function") {
                layer.setStyle(defaultStyle);
                layersReset++;
              } else if (
                layer &&
                layer.eachLayer &&
                typeof layer.eachLayer === "function"
              ) {
                layer.eachLayer(function (subLayer) {
                  if (subLayer.setStyle) {
                    subLayer.setStyle(defaultStyle);
                    layersReset++;
                  }
                });
              }
            } catch (e) {
              // متغير غير موجود، تجاهل
            }
          });

          console.log(`تم إعادة ضبط ${layersReset} طبقة من نوع ${layerType}`);
        } catch (error) {
          console.error(`خطأ في إعادة ضبط طبقة ${layerType}:`, error);
        }
      }

      // إضافة وظيفة تطبيق الأنماط على الطبقات
      document.addEventListener("DOMContentLoaded", function () {
        const applyStyleBtn = document.getElementById("applyStyleBtn");
        const resetStyleBtn = document.getElementById("resetStyleBtn");

        if (applyStyleBtn) {
          applyStyleBtn.addEventListener("click", function () {
            const layerSelect = document.getElementById("layerStyleSelect");
            const colorInput = document.getElementById("layerColor");
            const opacityInput = document.getElementById("layerOpacity");
            const lineWeightInput = document.getElementById("layerLineWeight");

            if (!layerSelect.value) {
              alert("يرجى اختيار طبقة أولاً");
              return;
            }

            const selectedLayer = layerSelect.value;
            const selectedColor = colorInput.value;
            const selectedOpacity = parseFloat(opacityInput.value);
            const selectedLineWeight = parseInt(lineWeightInput.value);

            console.log("تطبيق الأنماط:", {
              layer: selectedLayer,
              color: selectedColor,
              opacity: selectedOpacity,
              lineWeight: selectedLineWeight,
            });

            // تطبيق الأنماط بناءً على نوع الطبقة المحددة
            if (selectedLayer === "neighborhoods") {
              applyStyleToNeighborhoods(
                selectedColor,
                selectedOpacity,
                selectedLineWeight
              );
            } else if (selectedLayer === "service-sectors") {
              applyStyleToServiceSectors(
                selectedColor,
                selectedOpacity,
                selectedLineWeight
              );
            }

            // إظهار رسالة نجاح
            showSuccessNotification("تم تطبيق الأنماط بنجاح!");
          });
        }

        if (resetStyleBtn) {
          resetStyleBtn.addEventListener("click", function () {
            // تأكيد من المستخدم قبل إعادة الضبط
            if (
              confirm(
                "هل أنت متأكد من إعادة ضبط جميع الأنماط إلى الإعدادات الافتراضية؟"
              )
            ) {
              resetAllLayersToDefault();

              // إعادة ضبط قيم الحقول إلى الافتراضية
              document.getElementById("layerColor").value = "#1e40af";
              document.getElementById("layerOpacity").value = "0.8";
              document.getElementById("opacityValue").textContent = "0.8";
              document.getElementById("layerLineWeight").value = "2";
              document.getElementById("lineWeightValue").textContent = "2";
              document.getElementById("layerStyleSelect").value = "";

              // إظهار رسالة نجاح
              showSuccessNotification("تم إعادة ضبط جميع الأنماط بنجاح!");
            }
          });
        }

        // تحديث قيمة الشفافية عند التغيير
        const opacityInput = document.getElementById("layerOpacity");
        const opacityValue = document.getElementById("opacityValue");

        if (opacityInput && opacityValue) {
          opacityInput.addEventListener("input", function () {
            opacityValue.textContent = this.value;
          });
        }

        // تحديث قيمة سمك الخط عند التغيير
        const lineWeightInput = document.getElementById("layerLineWeight");
        const lineWeightValue = document.getElementById("lineWeightValue");

        if (lineWeightInput && lineWeightValue) {
          lineWeightInput.addEventListener("input", function () {
            lineWeightValue.textContent = this.value;
          });
        }
      });

      // دالة تطبيق الأنماط على طبقة الأحياء
      function applyStyleToNeighborhoods(color, opacity, lineWeight) {
        try {
          let layersStyled = 0;
          const styleObject = {
            color: color,
            fillColor: color,
            fillOpacity: opacity,
            opacity: opacity > 0.5 ? 0.8 : opacity + 0.3,
            weight: lineWeight || 2,
          };

          // البحث عن طبقة الأحياء في الخريطة
          if (window.map && window.map.eachLayer) {
            window.map.eachLayer(function (layer) {
              // التحقق من أن هذه طبقة الأحياء بناءً على خصائص مختلفة محتملة
              if (
                layer.feature &&
                layer.feature.properties &&
                (layer.feature.properties.NAME ||
                  layer.feature.properties.name ||
                  layer.feature.properties.Name ||
                  layer.feature.properties.ID)
              ) {
                // تطبيق الأنماط الجديدة
                layer.setStyle(styleObject);
                layersStyled++;
              }
            });
          }

          // محاولة أخرى للوصول للطبقات عبر متغيرات عامة محتملة
          const possibleVariables = [
            "neighborhoodsLayer",
            "neighborhoods",
            "neighborhoodsData",
            "window.neighborhoodsLayer",
          ];

          possibleVariables.forEach((varName) => {
            try {
              let layer = eval(varName);
              if (layer && typeof layer.setStyle === "function") {
                layer.setStyle(styleObject);
                layersStyled++;
              } else if (
                layer &&
                layer.eachLayer &&
                typeof layer.eachLayer === "function"
              ) {
                layer.eachLayer(function (subLayer) {
                  if (subLayer.setStyle) {
                    subLayer.setStyle(styleObject);
                    layersStyled++;
                  }
                });
              }
            } catch (e) {
              // متغير غير موجود، تجاهل
            }
          });

          console.log(`تم تطبيق الأنماط على ${layersStyled} طبقة من الأحياء`);

          if (layersStyled === 0) {
            console.warn(
              "لم يتم العثور على أي طبقة من الأحياء لتطبيق الأنماط عليها"
            );
          }
        } catch (error) {
          console.error("خطأ في تطبيق الأنماط على الأحياء:", error);
        }
      }

      // دالة تطبيق الأنماط على طبقة دوائر الخدمات
      function applyStyleToServiceSectors(color, opacity, lineWeight) {
        try {
          let layersStyled = 0;
          const styleObject = {
            color: color,
            fillColor: color,
            fillOpacity: opacity,
            opacity: opacity > 0.5 ? 0.8 : opacity + 0.3,
            weight: lineWeight || 2,
          };

          // البحث عن طبقة دوائر الخدمات في الخريطة
          if (window.map && window.map.eachLayer) {
            window.map.eachLayer(function (layer) {
              // التحقق من أن هذه طبقة دوائر الخدمات بناءً على الخصائص الصحيحة
              if (
                layer.feature &&
                layer.feature.properties &&
                (layer.feature.properties.Name ||
                  layer.feature.properties.OBJECTID)
              ) {
                // تطبيق الأنماط الجديدة
                layer.setStyle(styleObject);
                layersStyled++;
              }
            });
          }

          // محاولة أخرى للوصول للطبقات عبر متغيرات عامة محتملة
          const possibleVariables = [
            "serviceSectorsLayer",
            "serviceSectors",
            "serviceSectorsData",
            "window.serviceSectorsLayer",
          ];

          possibleVariables.forEach((varName) => {
            try {
              let layer = eval(varName);
              if (layer && typeof layer.setStyle === "function") {
                layer.setStyle(styleObject);
                layersStyled++;
              } else if (
                layer &&
                layer.eachLayer &&
                typeof layer.eachLayer === "function"
              ) {
                layer.eachLayer(function (subLayer) {
                  if (subLayer.setStyle) {
                    subLayer.setStyle(styleObject);
                    layersStyled++;
                  }
                });
              }
            } catch (e) {
              // متغير غير موجود، تجاهل
            }
          });

          // البحث عن الطبقات عبر selectors DOM
          const checkboxes = document.querySelectorAll(
            '[data-layer*="service-sectors"]'
          );
          if (checkboxes.length > 0) {
            console.log(
              "تم العثور على عناصر دوائر الخدمات في DOM:",
              checkboxes.length
            );
          }

          console.log(
            `تم تطبيق الأنماط على ${layersStyled} طبقة من دوائر الخدمات`
          );

          if (layersStyled === 0) {
            console.warn(
              "لم يتم العثور على أي طبقة من دوائر الخدمات لتطبيق الأنماط عليها"
            );
          }
        } catch (error) {
          console.error("خطأ في تطبيق الأنماط على دوائر الخدمات:", error);
        }
      }

      // تكامل الخريطة مع نظام التبويبات
      document.addEventListener("DOMContentLoaded", function () {
        // التأكد من أن الخريطة جاهزة قبل إعداد التكامل
        const checkMapReady = setInterval(function () {
          if (window.map && typeof window.setSelectedSector === "function") {
            clearInterval(checkMapReady);

            // إعداد التكامل عندما تكون الخريطة جاهزة
            setupMapTabsIntegration();
          }
        }, 100);
      });

      function setupMapTabsIntegration() {
        console.log("إعداد التكامل بين الخريطة والتبويبات...");

        // عند إظهار info-panel، أظهر tabs تلقائياً
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              const target = mutation.target;
              if (
                target.id === "info-panel" &&
                target.classList.contains("show")
              ) {
                // إظهار tabs-container عند إظهار info-panel
                const tabsContainer = document.querySelector(".tabs-container");
                if (tabsContainer) {
                  tabsContainer.classList.add("visible");
                  tabsContainer.classList.remove("hidden", "collapsed");
                  tabsContainer.style.display = "block";
                }
              }
            }
          });
        });

        const infoPanel = document.getElementById("info-panel");
        if (infoPanel) {
          observer.observe(infoPanel, {
            attributes: true,
            attributeFilter: ["class"],
          });
        }

        // إضافة مستمع أحداث لإخفاء tabs عند إغلاق info-panel
        const closeButton = document.getElementById("close-info-panel");
        if (closeButton) {
          closeButton.addEventListener("click", function () {
            const tabsContainer = document.querySelector(".tabs-container");
            if (tabsContainer) {
              tabsContainer.classList.remove("visible");
              tabsContainer.classList.add("hidden");
              setTimeout(function () {
                tabsContainer.style.display = "none";
              }, 300);
            }
          });
        }

        // إضافة مستمع أحداث للbackdrop لإخفاء tabs
        const backdrop = document.querySelector(".modal-backdrop");
        if (backdrop) {
          backdrop.addEventListener("click", function () {
            const tabsContainer = document.querySelector(".tabs-container");
            if (tabsContainer) {
              tabsContainer.classList.remove("visible");
              tabsContainer.classList.add("hidden");
              setTimeout(function () {
                tabsContainer.style.display = "none";
              }, 300);
            }
          });
        }

        console.log("تم إعداد التكامل بين الخريطة والتبويبات بنجاح");
      }
    </script>
  </body>
</html>
